<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{layout :: head}">
    <title>Î∞±ÌÖåÏä§ÌåÖ ÏÉÅÏÑ∏</title>
</head>
<body data-theme="light">
    <!-- Header -->
    <nav th:replace="~{layout :: header}"></nav>

    <!-- Sidebar -->
    <nav th:replace="~{layout :: sidebar}"></nav>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Breadcrumb -->
        <nav th:replace="~{layout :: breadcrumb}"></nav>

        <!-- Page Header -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h1 class="h3 mb-1">Î∞±ÌÖåÏä§ÌåÖ ÏÉÅÏÑ∏</h1>
                <p class="text-muted mb-0">Î∞±ÌÖåÏä§ÌåÖ Í≤∞Í≥º ÏÉÅÏÑ∏ Ï†ïÎ≥¥Î•º ÌôïÏù∏ÌïòÏÑ∏Ïöî</p>
            </div>
            <div>
                <a href="/backtest" class="btn btn-secondary">
                    <i class="bi bi-arrow-left me-1"></i>
                    Î™©Î°ùÏúºÎ°ú
                </a>
                <div th:if="${backtest.canCancel()}" class="d-inline">
                    <button class="btn btn-danger ms-2" onclick="cancelBacktest()">
                        <i class="bi bi-x-circle me-1"></i>
                        Ï∑®ÏÜå
                    </button>
                </div>
            </div>
        </div>

        <!-- Content -->
        <div class="container-fluid">
                <!-- Error/Success Messages -->
                <div th:if="${errorMessage}" class="alert alert-danger alert-dismissible fade show" role="alert">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    <span th:text="${errorMessage}"></span>
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>

                <div th:if="${successMessage}" class="alert alert-success alert-dismissible fade show" role="alert">
                    <i class="bi bi-check-circle me-2"></i>
                    <span th:text="${successMessage}"></span>
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>

                <div class="row">
                    <!-- Basic Information -->
                    <div class="col-lg-9">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">
                                    <i class="bi bi-info-circle me-2"></i>
                                    Í∏∞Î≥∏ Ï†ïÎ≥¥
                                </h3>
                                <div class="card-tools">
                                    <span class="badge"
                                          th:classappend="${backtest.status.name() == 'COMPLETED' ? 'bg-success' :
                                                           backtest.status.name() == 'RUNNING' ? 'bg-primary' :
                                                           backtest.status.name() == 'FAILED' ? 'bg-danger' :
                                                           backtest.status.name() == 'CANCELLED' ? 'bg-secondary' : 'bg-warning'}"
                                          th:text="${backtest.status.displayName}">
                                    </span>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <dl class="row">
                                            <dt class="col-sm-3">ID:</dt>
                                            <dd class="col-sm-9">
                                                <code th:text="${backtest.id.value}"></code>
                                            </dd>

                                            <dt class="col-sm-3">Ï¢ÖÎ™©:</dt>
                                            <dd class="col-sm-9">
                                                <strong th:text="${backtest.config.stockName}"></strong>
                                                <small class="text-muted" th:text="'(' + ${backtest.config.stockCode} + ')'"></small>
                                            </dd>

                                            <dt class="col-sm-3">Ï†ÑÎûµ:</dt>
                                            <dd class="col-sm-9">
                                                <span class="badge bg-info" th:text="${backtest.config.strategyType.displayName}"></span>
                                            </dd>

                                            <dt class="col-sm-3">Í∏∞Í∞Ñ:</dt>
                                            <dd class="col-sm-9">
                                                <span th:text="${#temporals.format(backtest.config.startDate, 'yyyy-MM-dd') + ' ~ ' + #temporals.format(backtest.config.endDate, 'yyyy-MM-dd')}"></span>
                                            </dd>
                                        </dl>
                                    </div>
                                    <div class="col-md-6">
                                        <dl class="row">
                                            <dt class="col-sm-4">Ï¥àÍ∏∞ÏûêÍ∏à:</dt>
                                            <dd class="col-sm-8">
                                                <span th:text="${#numbers.formatDecimal(backtest.config.initialCapital, 0, 'COMMA', 0, 'POINT')} + 'Ïõê'"></span>
                                            </dd>

                                            <dt class="col-sm-4">ÏÉùÏÑ±Ïùº:</dt>
                                            <dd class="col-sm-8">
                                                <span th:text="${#temporals.format(backtest.createdAt, 'yyyy-MM-dd HH:mm:ss')}"></span>
                                            </dd>

                                            <dt class="col-sm-4">ÏôÑÎ£åÏùº:</dt>
                                            <dd class="col-sm-8">
                                                <span th:if="${backtest.completedAt != null}" th:text="${#temporals.format(backtest.completedAt, 'yyyy-MM-dd HH:mm:ss')}"></span>
                                                <span th:if="${backtest.completedAt == null}" class="text-muted">-</span>
                                            </dd>

                                            <dt class="col-sm-4" th:if="${backtest.errorMessage != null}">Ïò§Î•ò:</dt>
                                            <dd class="col-sm-8" th:if="${backtest.errorMessage != null}">
                                                <span class="text-danger" th:text="${backtest.errorMessage}"></span>
                                            </dd>
                                        </dl>
                                    </div>
                                </div>

                                <!-- Progress Bar for Running Backtests -->
                                <div th:if="${backtest.status.name() == 'RUNNING'}" class="mt-3">
                                    <div class="d-flex justify-content-between">
                                        <small class="text-muted">ÏßÑÌñâÎ•†</small>
                                        <small class="text-muted">
                                            <span id="progressText" th:text="${backtest.progressPercentage} + '%'"></span>
                                        </small>
                                    </div>
                                    <div class="progress">
                                        <div id="progressBar" class="progress-bar bg-primary progress-bar-animated"
                                             th:style="'width: ' + ${backtest.progressPercentage} + '%'"></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>

                    <!-- Trade History -->
                    <div class="col-lg-3">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">
                                    <i class="bi bi-list-ul me-2"></i>
                                    Í±∞Îûò ÎÇ¥Ïó≠
                                </h3>
                            </div>
                            <div class="card-body" style="max-height: 500px; overflow-y: auto;">
                                <div th:if="${backtest.trades.empty}" class="text-center text-muted py-4">
                                    <i class="bi bi-inbox display-4"></i>
                                    <p class="mt-2">Í±∞Îûò ÎÇ¥Ïó≠Ïù¥ ÏóÜÏäµÎãàÎã§</p>
                                </div>

                                <div th:if="${!backtest.trades.empty}">
                                    <div th:each="trade : ${backtest.trades}" class="border-bottom py-2">
                                        <div class="d-flex justify-content-between align-items-start">
                                            <div>
                                                <span class="badge"
                                                      th:classappend="${trade.type.name() == 'BUY'} ? 'bg-danger' : 'bg-success'"
                                                      th:text="${trade.type.displayName}">
                                                </span>
                                                <div class="mt-1">
                                                    <small class="text-muted" th:text="${#temporals.format(trade.timestamp, 'MM-dd HH:mm')}"></small>
                                                </div>
                                            </div>
                                            <div class="text-end">
                                                <div><strong th:text="${#numbers.formatDecimal(trade.price, 0, 'COMMA', 0, 'POINT')} + 'Ïõê'"></strong></div>
                                                <div><small th:text="${#numbers.formatDecimal(trade.quantity, 0, 'COMMA', 0, 'POINT')} + 'Ï£º'"></small></div>
                                            </div>
                                        </div>
                                        <div th:if="${trade.reason}" class="mt-1">
                                            <small class="text-muted" th:text="${trade.reason}"></small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>

                <!-- Backtest Results Section (New Full-Width Row) -->
                <div th:if="${backtest.result != null}" class="row mt-4">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">
                                    <i class="bi bi-bar-chart me-2"></i>
                                    Î∞±ÌÖåÏä§ÌåÖ Í≤∞Í≥º
                                </h3>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-lg-6">
                                        <div class="card border-0 shadow-sm">
                                            <div class="card-body text-center">
                                                <i th:class="${backtest.result.totalReturn >= 0} ? 'bi bi-arrow-up-circle text-success' : 'bi bi-arrow-down-circle text-danger'" style="font-size: 2.0rem;"></i>
                                                <h6 class="card-title mt-2">Ï¥ù ÏàòÏùµÎ•†</h6>
                                                <h4 class="card-text fw-bold"
                                                    th:classappend="${backtest.result.totalReturn >= 0} ? 'text-success' : 'text-danger'"
                                                    th:text="${#numbers.formatDecimal(backtest.result.totalReturn, 1, 'COMMA', 2, 'POINT')} + '%'">
                                                </h4>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="col-lg-6">
                                        <div class="card border-0 shadow-sm">
                                            <div class="card-body text-center">
                                                <i class="bi bi-arrow-repeat text-info" style="font-size: 2.0rem;"></i>
                                                <h6 class="card-title mt-2">Ï¥ù Í±∞Îûò ÌöüÏàò</h6>
                                                <h4 class="card-text fw-bold" th:text="${backtest.result.totalTrades} + 'Ìöå'"></h4>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="row mt-3">
                                    <div class="col-lg-4">
                                        <div class="card border-0 bg-success text-white">
                                            <div class="card-body text-center">
                                                <i class="bi bi-check-circle" style="font-size: 1.5rem;"></i>
                                                <h5 class="card-title mt-2">ÏäπÎ¶¨ Í±∞Îûò</h5>
                                                <h3 class="card-text fw-bold" th:text="${backtest.result.winTrades}"></h3>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="col-lg-4">
                                        <div class="card border-0 bg-danger text-white">
                                            <div class="card-body text-center">
                                                <i class="bi bi-x-circle" style="font-size: 1.5rem;"></i>
                                                <h5 class="card-title mt-2">ÏÜêÏã§ Í±∞Îûò</h5>
                                                <h3 class="card-text fw-bold" th:text="${backtest.result.lossTrades}"></h3>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="col-lg-4">
                                        <div class="card border-0 bg-info text-white">
                                            <div class="card-body text-center">
                                                <i class="bi bi-receipt" style="font-size: 1.5rem;"></i>
                                                <h5 class="card-title mt-2">Ï¥ù ÏàòÏàòÎ£å</h5>
                                                <h3 class="card-text fw-bold" th:text="${#numbers.formatDecimal(backtest.result.totalFees, 0, 'COMMA', 0, 'POINT')} + 'Ïõê'"></h3>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Financial Summary -->
                                <div class="alert alert-info mt-3">
                                    <h6><i class="bi bi-calculator me-1"></i> Ìà¨Ïûê ÏàòÏùµ ÏöîÏïΩ</h6>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <ul class="list-unstyled mb-0">
                                                <li><strong>Ï¥àÍ∏∞ ÏûêÎ≥∏:</strong> <span th:text="${#numbers.formatDecimal(backtest.config.initialCapital, 0, 'COMMA', 0, 'POINT')} + 'Ïõê'"></span></li>
                                                <li><strong>ÏµúÏ¢Ö ÏûêÎ≥∏:</strong> <span th:text="${#numbers.formatDecimal(backtest.result.finalCapital, 0, 'COMMA', 0, 'POINT')} + 'Ïõê'"></span></li>
                                            </ul>
                                        </div>
                                        <div class="col-md-6">
                                            <ul class="list-unstyled mb-0">
                                                <li><strong>Ïàú ÏÜêÏùµ:</strong>
                                                    <span th:classappend="${backtest.result.getProfitLoss(backtest.config.initialCapital) >= 0} ? 'text-success' : 'text-danger'"
                                                          th:text="${#numbers.formatDecimal(backtest.result.getProfitLoss(backtest.config.initialCapital), 0, 'COMMA', 0, 'POINT')} + 'Ïõê'"></span>
                                                </li>
                                                <li><strong>Ïó∞Ïú®Ìôî ÏàòÏùµÎ•†:</strong> <span th:text="${#numbers.formatDecimal(backtest.result.annualizedReturn, 1, 'COMMA', 2, 'POINT')} + '%'"></span></li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Strategy Calculation Logs Section (New Full-Width Row) -->
                <div class="row mt-4">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">
                                    <i class="bi bi-calculator me-2"></i>
                                    Ï†ÑÎûµ Í≥ÑÏÇ∞ Í≥ºÏ†ï
                                </h3>
                            </div>
                            <div class="card-body border-bottom py-3">
                                <div class="d-flex justify-content-center">
                                    <div class="btn-group" role="group" aria-label="Î°úÍ∑∏ ÌÉÄÏûÖ ÌïÑÌÑ∞">
                                        <button type="button" class="btn btn-secondary filter-btn active" onclick="filterLogs('all')" id="filter-all">
                                            Ï†ÑÏ≤¥
                                        </button>
                                        <button type="button" class="btn btn-outline-info filter-btn" onclick="filterLogs('CALCULATION')" id="filter-calculation">
                                            üìä Í≥ÑÏÇ∞
                                        </button>
                                        <button type="button" class="btn btn-outline-warning filter-btn" onclick="filterLogs('SIGNAL')" id="filter-signal">
                                            üéØ Ïã†Ìò∏
                                        </button>
                                        <button type="button" class="btn btn-outline-primary filter-btn" onclick="filterLogs('DECISION')" id="filter-decision">
                                            üí≠ ÌåêÎã®
                                        </button>
                                        <button type="button" class="btn btn-outline-success filter-btn" onclick="filterLogs('TRADE_EXECUTION')" id="filter-execution">
                                            üí∞ Ï≤¥Í≤∞
                                        </button>
                                    </div>
                                </div>

                                <!-- Debug Status Area -->
                                <div class="text-center py-2">
                                    <small class="text-muted" id="debug-status">ÌïÑÌÑ∞ ÏãúÏä§ÌÖú Ï§ÄÎπÑ Ï§ë...</small>
                                    <div class="mt-1">
                                        <span class="badge bg-secondary me-1" id="status-dom">DOM</span>
                                        <span class="badge bg-secondary me-1" id="status-clicks">ÌÅ¥Î¶≠</span>
                                        <span class="badge bg-secondary me-1" id="status-filters">ÌïÑÌÑ∞</span>
                                        <span class="badge bg-secondary" id="status-logs">Î°úÍ∑∏</span>
                                    </div>
                                </div>
                            </div>
                            <div>
                                <div class="card-body" style="max-height: 600px; overflow-y: auto;">
                                    <div th:if="${strategyLogs == null or strategyLogs.empty}" class="text-center text-muted py-4">
                                        <i class="bi bi-journal-x display-4"></i>
                                        <p class="mt-2">Í≥ÑÏÇ∞ Í≥ºÏ†ï Î°úÍ∑∏Í∞Ä ÏóÜÏäµÎãàÎã§</p>
                                        <small class="text-muted">Î∞±ÌÖåÏä§ÌåÖ Ïã§Ìñâ Ïãú Í≥ÑÏÇ∞ Í≥ºÏ†ïÏù¥ Í∏∞Î°ùÎê©ÎãàÎã§</small>
                                        <!-- DEBUG INFO -->
                                        <div style="border: 1px dashed red; padding: 10px; margin: 10px; background: #ffe6e6;">
                                            <strong>DEBUG:</strong><br/>
                                            strategyLogs is null: <span th:text="${strategyLogs == null}"></span><br/>
                                            strategyLogs is empty: <span th:text="${strategyLogs != null ? strategyLogs.empty : 'N/A'}"></span><br/>
                                            strategyLogs size: <span th:text="${strategyLogs != null ? strategyLogs.size() : 'null'}"></span><br/>
                                        </div>
                                    </div>

                                    <div th:if="${strategyLogs != null and !strategyLogs.empty}">

                                        <!-- Calculation logs timeline -->
                                        <div class="timeline">
                                            <div th:each="log : ${strategyLogs}" class="timeline-item" th:attr="data-log-type=${log.logType.name()}">
                                                <div class="timeline-marker"
                                                     th:class="${'timeline-marker ' + (log.logType.name() == 'CALCULATION' ? 'bg-info' :
                                                                                       log.logType.name() == 'SIGNAL' ? 'bg-warning' :
                                                                                       log.logType.name() == 'DECISION' ? 'bg-primary' :
                                                                                       log.logType.name() == 'TRADE_EXECUTION' ? 'bg-success' : 'bg-secondary')}">
                                                    <span th:text="${log.logType.name() == 'CALCULATION' ? 'üìä' :
                                                                         log.logType.name() == 'SIGNAL' ? 'üéØ' :
                                                                         log.logType.name() == 'DECISION' ? 'üí≠' :
                                                                         log.logType.name() == 'TRADE_EXECUTION' ? 'üí∞' : 'üìù'}"></span>
                                                </div>
                                                <div class="timeline-content">
                                                    <div class="card border-0 shadow-sm">
                                                        <div class="card-header py-2"
                                                             th:class="${log.logType.name() == 'CALCULATION' ? 'card-header py-2 bg-info bg-opacity-10' :
                                                                                    log.logType.name() == 'SIGNAL' ? 'card-header py-2 bg-warning bg-opacity-10' :
                                                                                    log.logType.name() == 'DECISION' ? 'card-header py-2 bg-primary bg-opacity-10' :
                                                                                    log.logType.name() == 'TRADE_EXECUTION' ? 'card-header py-2 bg-success bg-opacity-10' : 'card-header py-2 bg-secondary bg-opacity-10'}">
                                                            <div class="d-flex justify-content-between align-items-center">
                                                                <small class="fw-bold text-muted">
                                                                    <span th:text="${#temporals.format(log.tradeDay, 'yyyy-MM-dd')}"></span>
                                                                    <span class="badge ms-1"
                                                                          th:class="${log.logType.name() == 'CALCULATION' ? 'badge ms-1 bg-info' :
                                                                                               log.logType.name() == 'SIGNAL' ? 'badge ms-1 bg-warning' :
                                                                                               log.logType.name() == 'DECISION' ? 'badge ms-1 bg-primary' :
                                                                                               log.logType.name() == 'TRADE_EXECUTION' ? 'badge ms-1 bg-success' : 'badge ms-1 bg-secondary'}"
                                                                          th:text="${log.logType.name() == 'CALCULATION' ? 'Í≥ÑÏÇ∞' :
                                                                                     log.logType.name() == 'SIGNAL' ? 'Ïã†Ìò∏' :
                                                                                     log.logType.name() == 'DECISION' ? 'ÌåêÎã®' :
                                                                                     log.logType.name() == 'TRADE_EXECUTION' ? 'Ï≤¥Í≤∞' : 'Í∏∞ÌÉÄ'}">
                                                                    </span>
                                                                </small>
                                                                <small class="text-muted">
                                                                    Step <span th:text="${log.stepSequence}"></span>
                                                                </small>
                                                            </div>
                                                        </div>
                                                        <div class="card-body py-2">
                                                            <div class="log-description mb-3">
                                                                <div style="font-size: 1.1rem;" th:text="${log.description}"></div>
                                                            </div>

                                                            <!-- Input Data -->
                                                            <div th:if="${log.inputDataMap != null and !log.inputDataMap.isEmpty()}" class="mb-3">
                                                                <div class="text-muted fw-bold mb-1" style="font-size: 0.95rem;">üì• ÏûÖÎ†• Îç∞Ïù¥ÌÑ∞:</div>
                                                                <div class="ms-3">
                                                                    <div th:each="entry : ${log.inputDataMap}" style="font-size: 0.9rem; margin-bottom: 4px;">
                                                                        <code th:text="${entry.key}"></code>:
                                                                        <span th:text="${entry.value}"></span>
                                                                    </div>
                                                                </div>
                                                            </div>

                                                            <!-- Calculation Details -->
                                                            <div th:if="${log.calculationDetailsMap != null and !log.calculationDetailsMap.isEmpty()}" class="mb-3">
                                                                <div class="text-muted fw-bold mb-1" style="font-size: 0.95rem;">‚öôÔ∏è Í≥ÑÏÇ∞ ÏÉÅÏÑ∏:</div>
                                                                <div class="ms-3">
                                                                    <div th:each="entry : ${log.calculationDetailsMap}" style="font-size: 0.9rem; margin-bottom: 4px;">
                                                                        <code th:text="${entry.key}"></code>:
                                                                        <span th:text="${entry.value}"></span>
                                                                    </div>
                                                                </div>
                                                            </div>

                                                            <!-- Output Result -->
                                                            <div th:if="${log.outputResultMap != null and !log.outputResultMap.isEmpty()}">
                                                                <div class="text-muted fw-bold mb-1" style="font-size: 0.95rem;">üì§ Í≤∞Í≥º:</div>
                                                                <div class="ms-3">
                                                                    <div th:each="entry : ${log.outputResultMap}" style="font-size: 0.9rem; margin-bottom: 4px;">
                                                                        <code th:text="${entry.key}"></code>:
                                                                        <strong th:text="${entry.value}"></strong>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer th:replace="~{layout :: footer}"></footer>

    <!-- Scripts -->
    <div th:replace="~{layout :: scripts}"></div>

    <!-- Cancel Backtest Form -->
    <form th:if="${backtest.canCancel()}" id="cancelForm" th:action="@{/backtest/{id}/cancel(id=${backtest.id.value})}" method="post" style="display: none;">
    </form>

    <!-- Timeline and Filter Styles -->
    <style>
        .timeline {
            position: relative;
            padding-left: 3rem;
        }

        .timeline::before {
            content: '';
            position: absolute;
            left: 1rem;
            top: 0;
            bottom: 0;
            width: 2px;
            background-color: #e9ecef;
        }

        .timeline-item {
            position: relative;
            margin-bottom: 1.5rem;
        }

        .timeline-marker {
            position: absolute;
            left: -2.5rem;
            top: 0.5rem;
            width: 2rem;
            height: 2rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            color: white;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .timeline-content {
            margin-left: 1rem;
        }

        .timeline-item[data-log-type="CALCULATION"] {
            border-left: 3px solid #0dcaf0;
            padding-left: 0.5rem;
        }

        .timeline-item[data-log-type="SIGNAL"] {
            border-left: 3px solid #ffc107;
            padding-left: 0.5rem;
        }

        .timeline-item[data-log-type="DECISION"] {
            border-left: 3px solid #0d6efd;
            padding-left: 0.5rem;
        }

        .timeline-item[data-log-type="TRADE_EXECUTION"] {
            border-left: 3px solid #198754;
            padding-left: 0.5rem;
        }

        .timeline-item.hidden {
            display: none;
        }

        /* Filter button styles - Enhanced with pointer-events */
        .filter-btn {
            min-width: 80px !important;
            padding: 10px 18px !important;
            margin: 0 2px !important;
            font-size: 14px !important;
            font-weight: 500 !important;
            border-width: 2px !important;
            transition: all 0.2s ease !important;
            cursor: pointer !important;
            pointer-events: auto !important;
            position: relative !important;
            z-index: 1000 !important;
            display: inline-block !important;
            user-select: none !important;
            -webkit-user-select: none !important;
            -moz-user-select: none !important;
            -ms-user-select: none !important;
        }

        .filter-btn:hover {
            transform: translateY(-1px) !important;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15) !important;
            cursor: pointer !important;
        }

        .filter-btn:active {
            transform: translateY(0) !important;
            background-color: rgba(0,0,0,0.1) !important;
        }

        .filter-btn.active {
            font-weight: 600 !important;
            border-width: 2px !important;
            box-shadow: 0 2px 12px rgba(0,0,0,0.2) !important;
        }

        /* Ensure button group container allows clicks */
        .btn-group {
            z-index: 999 !important;
            position: relative !important;
        }

        .card-body.border-bottom {
            position: relative !important;
            z-index: 998 !important;
            pointer-events: auto !important;
        }
    </style>

    <!-- JavaScript -->
    <script>
        function cancelBacktest() {
            if (confirm('Ï†ïÎßêÎ°ú Ïù¥ Î∞±ÌÖåÏä§ÌåÖÏùÑ Ï∑®ÏÜåÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) {
                document.getElementById('cancelForm').submit();
            }
        }

        // Update visual status - ensure global scope
        window.updateStatus = function(elementId, status, success = false) {
            const element = document.getElementById(elementId);
            if (element) {
                element.className = success ? 'badge bg-success me-1' : 'badge bg-danger me-1';
                element.textContent = status;
            }
        }

        // Strategy log filtering - direct onclick approach with debugging
        // Ensure function is in global scope
        window.filterLogs = function(filterType) {
            console.log('üöÄ filterLogs called with:', filterType);
            updateStatus('debug-status', `ÌïÑÌÑ∞ÎßÅ Ï§ë: ${filterType}`);
            updateStatus('status-clicks', 'ÌÅ¥Î¶≠Îê®', true);

            try {
                // Reset all buttons first
                console.log('üîÑ Resetting all buttons...');
                const allButtons = ['filter-all', 'filter-calculation', 'filter-signal', 'filter-decision', 'filter-execution'];

                allButtons.forEach(buttonId => {
                    const btn = document.getElementById(buttonId);
                    if (btn) {
                        console.log('‚úÖ Found button:', buttonId);
                        btn.classList.remove('btn-secondary', 'btn-info', 'btn-warning', 'btn-primary', 'btn-success', 'active');

                        // Set base outline style
                        if (buttonId === 'filter-all') {
                            btn.classList.add('btn-outline-secondary');
                        } else if (buttonId === 'filter-calculation') {
                            btn.classList.add('btn-outline-info');
                        } else if (buttonId === 'filter-signal') {
                            btn.classList.add('btn-outline-warning');
                        } else if (buttonId === 'filter-decision') {
                            btn.classList.add('btn-outline-primary');
                        } else if (buttonId === 'filter-execution') {
                            btn.classList.add('btn-outline-success');
                        }
                    } else {
                        console.warn('‚ùå Button not found:', buttonId);
                    }
                });

                // Set active button
                console.log('üéØ Setting active button for filter:', filterType);
                let activeButtonId = '';
                let activeClass = '';

                switch(filterType) {
                    case 'all':
                        activeButtonId = 'filter-all';
                        activeClass = 'btn-secondary';
                        break;
                    case 'CALCULATION':
                        activeButtonId = 'filter-calculation';
                        activeClass = 'btn-info';
                        break;
                    case 'SIGNAL':
                        activeButtonId = 'filter-signal';
                        activeClass = 'btn-warning';
                        break;
                    case 'DECISION':
                        activeButtonId = 'filter-decision';
                        activeClass = 'btn-primary';
                        break;
                    case 'TRADE_EXECUTION':
                        activeButtonId = 'filter-execution';
                        activeClass = 'btn-success';
                        break;
                }

                const activeBtn = document.getElementById(activeButtonId);
                if (activeBtn) {
                    console.log('‚úÖ Setting active:', activeButtonId, activeClass);
                    activeBtn.classList.remove('btn-outline-secondary', 'btn-outline-info', 'btn-outline-warning', 'btn-outline-primary', 'btn-outline-success');
                    activeBtn.classList.add(activeClass, 'active');
                }

                // Filter timeline items
                console.log('üîç Filtering timeline items...');
                const timelineItems = document.querySelectorAll('.timeline-item');
                console.log('üìã Found timeline items:', timelineItems.length);

                let visibleCount = 0;
                timelineItems.forEach((item, index) => {
                    const itemLogType = item.getAttribute('data-log-type');
                    console.log(`üìÑ Item ${index}: logType='${itemLogType}', filter='${filterType}'`);

                    if (filterType === 'all' || itemLogType === filterType) {
                        item.style.display = 'block';
                        visibleCount++;
                        console.log(`‚úÖ Showing item ${index}`);
                    } else {
                        item.style.display = 'none';
                        console.log(`‚ùå Hiding item ${index}`);
                    }
                });

                console.log(`üéâ Filtering complete! Visible: ${visibleCount}/${timelineItems.length}`);
                updateStatus('status-filters', 'ÏôÑÎ£å', true);
                updateStatus('status-logs', `${visibleCount}Í∞ú`, true);
                updateStatus('debug-status', `${filterType} ÌïÑÌÑ∞ Ï†ÅÏö© ÏôÑÎ£å: ${visibleCount}Í∞ú ÌëúÏãú`);

            } catch (error) {
                console.error('üí• Error in filterLogs:', error);
                updateStatus('status-filters', 'Ïò§Î•ò', false);
                updateStatus('debug-status', 'ÌïÑÌÑ∞ÎßÅ Ïò§Î•ò Î∞úÏÉù');
            }
        }

        // Test function to check if script is loaded
        function testFilter() {
            console.log('üß™ Test function called - script is loaded!');
            filterLogs('all');
        }

        // Add DOM ready and button click debugging
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üé¨ DOM Content Loaded - Setting up filters...');
            updateStatus('status-dom', 'Î°úÎìúÎê®', true);
            updateStatus('debug-status', 'DOM Î°úÎìú ÏôÑÎ£å, Î≤ÑÌäº ÏÑ§Ï†ï Ï§ë...');

            // Find and test all filter buttons
            const filterButtons = document.querySelectorAll('.filter-btn');
            console.log('üîç Found filter buttons:', filterButtons.length);

            if (filterButtons.length === 0) {
                updateStatus('debug-status', '‚ùå ÌïÑÌÑ∞ Î≤ÑÌäºÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏùå');
                updateStatus('status-clicks', 'ÏóÜÏùå', false);
                return;
            }

            filterButtons.forEach((btn, index) => {
                console.log(`üìã Button ${index}:`, {
                    id: btn.id,
                    className: btn.className,
                    text: btn.textContent.trim(),
                    hasOnclick: btn.hasAttribute('onclick'),
                    onclickValue: btn.getAttribute('onclick')
                });

                // Add additional event listener for debugging
                btn.addEventListener('click', function(event) {
                    console.log('üéØ Direct click listener triggered on:', btn.id);
                    updateStatus('status-clicks', 'Í∞êÏßÄÎê®', true);
                    console.log('üéØ Event details:', {
                        target: event.target,
                        currentTarget: event.currentTarget,
                        type: event.type,
                        bubbles: event.bubbles
                    });
                });

                // Test visual feedback
                btn.addEventListener('mousedown', function() {
                    console.log('üëá Mouse down on:', btn.id);
                    updateStatus('status-clicks', 'ÎàÑÎ¶Ñ', true);
                });

                btn.addEventListener('mouseup', function() {
                    console.log('üëÜ Mouse up on:', btn.id);
                });
            });

            updateStatus('debug-status', `${filterButtons.length}Í∞ú Î≤ÑÌäº ÏÑ§Ï†ï ÏôÑÎ£å`);

            // Test initial state
            console.log('üîÑ Testing initial filter state...');
            updateStatus('debug-status', 'Ï¥àÍ∏∞ ÌïÑÌÑ∞ ÌÖåÏä§Ìä∏ Ï§ë...');
            testFilter();
        });

        // Log when script loads
        console.log('üìú Filter script loaded successfully!');


        // Auto-refresh for running backtests
        if ([[ ${backtest.status.name() == 'RUNNING'} ]]) {
            const backtestId = '[[ ${backtest.id.value} ]]';

            function updateProgress() {
                fetch(`/backtest/${backtestId}/progress`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.error) {
                            console.error('Error fetching progress:', data.error);
                            return;
                        }

                        // Update progress bar
                        const progressBar = document.getElementById('progressBar');
                        const progressText = document.getElementById('progressText');

                        if (progressBar && progressText) {
                            progressBar.style.width = data.progress + '%';
                            progressText.textContent = data.progress + '%';
                        }

                        // Refresh page if completed
                        if (data.status === 'COMPLETED' || data.status === 'FAILED' || data.status === 'CANCELLED') {
                            setTimeout(() => {
                                window.location.reload();
                            }, 1000);
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching progress:', error);
                    });
            }

            // Update every 2 seconds
            setInterval(updateProgress, 2000);
        }
    </script>
</body>
</html>