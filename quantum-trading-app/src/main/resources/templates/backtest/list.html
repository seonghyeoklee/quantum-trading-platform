<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{layout :: head}">
    <title>백테스팅 목록</title>
</head>
<body data-theme="light">
    <!-- Header -->
    <nav th:replace="~{layout :: header}"></nav>

    <!-- Sidebar -->
    <nav th:replace="~{layout :: sidebar}"></nav>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Breadcrumb -->
        <nav th:replace="~{layout :: breadcrumb}"></nav>

        <!-- Page Header -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h1 class="h3 mb-1">백테스팅 목록</h1>
                <p class="text-muted mb-0">백테스팅 결과를 조회하고 관리하세요</p>
            </div>
            <div>
                <a th:href="@{/backtest/create}" class="btn btn-primary">
                    <i class="bi bi-plus-circle me-1"></i>
                    새 백테스팅
                </a>
            </div>
        </div>

        <!-- Content -->
        <div class="container-fluid">
                <!-- Error/Success Messages -->
                <div th:if="${errorMessage}" class="alert alert-danger alert-dismissible fade show" role="alert">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    <span th:text="${errorMessage}"></span>
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>

                <div th:if="${successMessage}" class="alert alert-success alert-dismissible fade show" role="alert">
                    <i class="bi bi-check-circle me-2"></i>
                    <span th:text="${successMessage}"></span>
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>

                <!-- Backtest List -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="bi bi-graph-up me-2"></i>
                            백테스팅 결과
                        </h3>
                    </div>
                    <div class="card-body">
                        <div th:if="${backtests.empty}" class="text-center py-5">
                            <i class="bi bi-inbox display-1 text-muted"></i>
                            <h4 class="text-muted mt-3">백테스팅 결과가 없습니다</h4>
                            <p class="text-muted">새로운 백테스팅을 생성해보세요.</p>
                            <a th:href="@{/backtest/create}" class="btn btn-primary">
                                <i class="bi bi-plus-circle me-1"></i>
                                첫 번째 백테스팅 시작
                            </a>
                        </div>

                        <div th:if="${!backtests.empty}">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>ID</th>
                                            <th>종목</th>
                                            <th>전략</th>
                                            <th>기간</th>
                                            <th>초기자금</th>
                                            <th>상태</th>
                                            <th>수익률</th>
                                            <th>생성일</th>
                                            <th>액션</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr th:each="backtest : ${backtests.content}">
                                            <td>
                                                <code th:text="${#strings.substring(backtest.id.value, 0, 8)}"></code>
                                            </td>
                                            <td>
                                                <strong th:text="${backtest.config.stockName}"></strong>
                                                <br>
                                                <small class="text-muted" th:text="${backtest.config.stockCode}"></small>
                                            </td>
                                            <td>
                                                <span class="badge bg-info"
                                                      th:text="${backtest.config.strategyType.displayName}"></span>
                                            </td>
                                            <td>
                                                <small th:text="${#temporals.format(backtest.config.startDate, 'yyyy-MM-dd')} + ' ~ ' + ${#temporals.format(backtest.config.endDate, 'yyyy-MM-dd')}"></small>
                                            </td>
                                            <td>
                                                <span th:text="${#numbers.formatDecimal(backtest.config.initialCapital, 0, 'COMMA', 0, 'POINT')} + '원'"></span>
                                            </td>
                                            <td>
                                                <span class="badge"
                                                      th:classappend="${backtest.status.name() == 'COMPLETED'} ? 'bg-success' :
                                                                     ${backtest.status.name() == 'RUNNING'} ? 'bg-primary' :
                                                                     ${backtest.status.name() == 'FAILED'} ? 'bg-danger' :
                                                                     ${backtest.status.name() == 'CANCELLED'} ? 'bg-secondary' : 'bg-warning'"
                                                      th:text="${backtest.status.displayName}">
                                                </span>
                                                <div th:if="${backtest.status.name() == 'RUNNING'}" class="progress mt-1" style="height: 3px;">
                                                    <div class="progress-bar bg-primary"
                                                         th:style="'width: ' + ${backtest.progressPercentage} + '%'"></div>
                                                </div>
                                            </td>
                                            <td>
                                                <span th:if="${backtest.result != null}"
                                                      class="fw-bold"
                                                      th:classappend="${backtest.result.totalReturn > 0} ? 'text-success' : 'text-danger'"
                                                      th:text="${#numbers.formatDecimal(backtest.result.totalReturn, 1, 'COMMA', 2, 'POINT')} + '%'">
                                                </span>
                                                <span th:if="${backtest.result == null}" class="text-muted">-</span>
                                            </td>
                                            <td>
                                                <small th:text="${#temporals.format(backtest.createdAt, 'MM-dd HH:mm')}"></small>
                                            </td>
                                            <td>
                                                <div class="btn-group btn-group-sm">
                                                    <a th:href="@{/backtest/{id}(id=${backtest.id.value})}"
                                                       class="btn btn-outline-primary btn-sm" title="상세보기">
                                                        <i class="bi bi-eye"></i>
                                                    </a>
                                                    <button th:if="${backtest.canCancel()}"
                                                            class="btn btn-outline-danger btn-sm"
                                                            title="취소"
                                                            onclick="cancelBacktest(this)"
                                                            th:data-id="${backtest.id.value}">
                                                        <i class="bi bi-x-circle"></i>
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>

                            <!-- Pagination -->
                            <nav th:if="${backtests.totalPages > 1}">
                                <ul class="pagination justify-content-center">
                                    <li class="page-item" th:classappend="${currentPage == 0} ? 'disabled'">
                                        <a class="page-link" th:href="@{/backtest(page=${currentPage - 1})}">이전</a>
                                    </li>

                                    <li th:each="page : ${#numbers.sequence(0, backtests.totalPages - 1)}"
                                        class="page-item"
                                        th:classappend="${page == currentPage} ? 'active'">
                                        <a class="page-link" th:href="@{/backtest(page=${page})}" th:text="${page + 1}"></a>
                                    </li>

                                    <li class="page-item" th:classappend="${currentPage >= backtests.totalPages - 1} ? 'disabled'">
                                        <a class="page-link" th:href="@{/backtest(page=${currentPage + 1})}">다음</a>
                                    </li>
                                </ul>
                            </nav>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer th:replace="~{layout :: footer}"></footer>

    <!-- Scripts -->
    <div th:replace="~{layout :: scripts}"></div>

    <!-- Cancel Backtest Script -->
    <script>
        function cancelBacktest(button) {
            const backtestId = button.getAttribute('data-id');

            if (confirm('정말로 이 백테스팅을 취소하시겠습니까?')) {
                // Create form and submit
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = `/backtest/${backtestId}/cancel`;

                document.body.appendChild(form);
                form.submit();
            }
        }
    </script>
</body>
</html>