"""
키움 실시간 데이터 필드 코드 매핑
공식 가이드에서 제공된 필드 코드와 설명 매핑
"""

from typing import Dict, Optional


# 키움 공식 가이드 기준 필드 매핑
FIELD_MAPPINGS: Dict[str, str] = {
    # 주문/계좌 관련
    "9201": "계좌번호",
    "9203": "주문번호", 
    "9205": "관리자사번",
    "9001": "종목코드,업종코드",
    "912": "주문업무분류",
    "913": "주문상태",
    "900": "주문수량",
    "901": "주문가격",
    "902": "미체결수량",
    "903": "체결누계금액",
    "904": "원주문번호",
    "905": "주문구분",
    "906": "매매구분",
    "907": "매도수구분",
    "908": "주문/체결시간",
    "909": "체결번호",
    "910": "체결가",
    "911": "체결량",
    
    # 시세 관련
    "10": "현재가",
    "11": "전일대비",
    "12": "등락률",
    "13": "누적거래량",
    "14": "누적거래대금",
    "15": "거래량",
    "16": "고가",
    "17": "저가",
    "18": "시가",
    "20": "체결시간",
    "27": "(최우선)매도호가",
    "28": "(최우선)매수호가",
    "29": "거래대금",
    "30": "등락율",
    
    # 종목 정보
    "302": "종목명",
    
    # 기타
    "914": "단위체결가",
    "915": "단위체결량",
    "938": "당일매매수수료",
    "939": "당일매매세금",
    "919": "거부사유",
    "920": "화면번호",
    "921": "터미널번호",
    "922": "신용구분",
    "923": "대출일",
    "10010": "시간외단일가_현재가",
    
    # 0D: 주식ETF_NAV 전용 필드들
    "21": "호가시간",
    
    # 매도호가 1~10
    "41": "매도호가1", "42": "매도호가2", "43": "매도호가3", "44": "매도호가4", "45": "매도호가5",
    "46": "매도호가6", "47": "매도호가7", "48": "매도호가8", "49": "매도호가9", "50": "매도호가10",
    
    # 매수호가 1~10  
    "51": "매수호가1", "52": "매수호가2", "53": "매수호가3", "54": "매수호가4", "55": "매수호가5",
    "56": "매수호가6", "57": "매수호가7", "58": "매수호가8", "59": "매수호가9", "60": "매수호가10",
    
    # 매도호가수량 1~10
    "61": "매도호가수량1", "62": "매도호가수량2", "63": "매도호가수량3", "64": "매도호가수량4", "65": "매도호가수량5",
    "66": "매도호가수량6", "67": "매도호가수량7", "68": "매도호가수량8", "69": "매도호가수량9", "70": "매도호가수량10",
    
    # 매수호가수량 1~10
    "71": "매수호가수량1", "72": "매수호가수량2", "73": "매수호가수량3", "74": "매수호가수량4", "75": "매수호가수량5",
    "76": "매수호가수량6", "77": "매수호가수량7", "78": "매수호가수량8", "79": "매수호가수량9", "80": "매수호가수량10",
    
    # 매도호가직전대비 1~10
    "81": "매도호가직전대비1", "82": "매도호가직전대비2", "83": "매도호가직전대비3", "84": "매도호가직전대비4", "85": "매도호가직전대비5",
    "86": "매도호가직전대비6", "87": "매도호가직전대비7", "88": "매도호가직전대비8", "89": "매도호가직전대비9", "90": "매도호가직전대비10",
    
    # 매수호가직전대비 1~10
    "91": "매수호가직전대비1", "92": "매수호가직전대비2", "93": "매수호가직전대비3", "94": "매수호가직전대비4", "95": "매수호가직전대비5",
    "96": "매수호가직전대비6", "97": "매수호가직전대비7", "98": "매수호가직전대비8", "99": "매수호가직전대비9", "100": "매수호가직전대비10",
    
    # 호가 총잔량 정보
    "121": "매도호가총잔량",
    "122": "매도호가총잔량직전대비",
    "125": "매수호가총잔량", 
    "126": "매수호가총잔량직전대비",
    
    # 예상체결 정보
    "23": "예상체결가",
    "24": "예상체결수량",
    "291": "예상체결가",  # 시간동안만 유효
    "292": "예상체결량",
    "293": "예상체결가전일대비기호",
    "294": "예상체결가전일대비",
    "295": "예상체결가전일대비등락율",
    
    # 잔량 및 비율 정보
    "128": "순매수잔량",
    "129": "매수비율",
    "138": "순매도잔량",
    "139": "매도비율",
    
    # 전일 대비 정보
    "200": "예상체결가전일종가대비",
    "201": "예상체결가전일종가대비등락율",
    "238": "예상체결가전일종가대비기호",
    
    # 기타 정보
    "299": "전일거래량대비예상체결율",
    "215": "장운영구분",
    "216": "투자자별ticker",
    
    # LP 호가수량 1~10
    "621": "LP매도호가수량1", "622": "LP매도호가수량2", "623": "LP매도호가수량3", "624": "LP매도호가수량4", "625": "LP매도호가수량5",
    "626": "LP매도호가수량6", "627": "LP매도호가수량7", "628": "LP매도호가수량8", "629": "LP매도호가수량9", "630": "LP매도호가수량10",
    "631": "LP매수호가수량1", "632": "LP매수호가수량2", "633": "LP매수호가수량3", "634": "LP매수호가수량4", "635": "LP매수호가수량5",
    "636": "LP매수호가수량6", "637": "LP매수호가수량7", "638": "LP매수호가수량8", "639": "LP매수호가수량9", "640": "LP매수호가수량10",
    
    # KRX 호가잔량 1~10
    "6044": "KRX매도호가잔량1", "6045": "KRX매도호가잔량2", "6046": "KRX매도호가잔량3", "6047": "KRX매도호가잔량4", "6048": "KRX매도호가잔량5",
    "6049": "KRX매도호가잔량6", "6050": "KRX매도호가잔량7", "6051": "KRX매도호가잔량8", "6052": "KRX매도호가잔량9", "6053": "KRX매도호가잔량10",
    "6054": "KRX매수호가잔량1", "6055": "KRX매수호가잔량2", "6056": "KRX매수호가잔량3", "6057": "KRX매수호가잔량4", "6058": "KRX매수호가잔량5",
    "6059": "KRX매수호가잔량6", "6060": "KRX매수호가잔량7", "6061": "KRX매수호가잔량8", "6062": "KRX매수호가잔량9", "6063": "KRX매수호가잔량10",
    "6064": "KRX매도호가총잔량",
    "6065": "KRX매수호가총잔량",
    
    # NXT 호가잔량 1~10
    "6066": "NXT매도호가잔량1", "6067": "NXT매도호가잔량2", "6068": "NXT매도호가잔량3", "6069": "NXT매도호가잔량4", "6070": "NXT매도호가잔량5",
    "6071": "NXT매도호가잔량6", "6072": "NXT매도호가잔량7", "6073": "NXT매도호가잔량8", "6074": "NXT매도호가잔량9", "6075": "NXT매도호가잔량10",
    "6076": "NXT매수호가잔량1", "6077": "NXT매수호가잔량2", "6078": "NXT매수호가잔량3", "6079": "NXT매수호가잔량4", "6080": "NXT매수호가잔량5",
    "6081": "NXT매수호가잔량6", "6082": "NXT매수호가잔량7", "6083": "NXT매수호가잔량8", "6084": "NXT매수호가잔량9", "6085": "NXT매수호가잔량10",
    "6086": "NXT매도호가총잔량",
    "6087": "NXT매수호가총잔량",
    
    # 중간가 정보
    "6100": "KRX중간가매도총잔량증감", "6101": "KRX중간가매도총잔량", "6102": "KRX중간가", "6103": "KRX중간가매수총잔량", "6104": "KRX중간가매수총잔량증감",
    "6105": "NXT중간가매도총잔량증감", "6106": "NXT중간가매도총잔량", "6107": "NXT중간가", "6108": "NXT중간가매수총잔량", "6109": "NXT중간가매수총잔량증감",
    "6110": "KRX중간가대비", "6111": "KRX중간가대비기호", "6112": "KRX중간가대비등락율",
    "6113": "NXT중간가대비", "6114": "NXT중간가대비기호", "6115": "NXT중간가대비등락율",
    
    # 0E: 주식시간외호가 전용 필드들
    "131": "시간외매도호가총잔량",
    "132": "시간외매도호가총잔량직전대비",
    "135": "시간외매수호가총잔량", 
    "136": "시간외매수호가총잔량직전대비",
    
    # 0F: 주식당일거래원 전용 필드들
    # 매도거래원 1~5
    "141": "매도거래원1", "142": "매도거래원2", "143": "매도거래원3", "144": "매도거래원4", "145": "매도거래원5",
    "161": "매도거래원수량1", "162": "매도거래원수량2", "163": "매도거래원수량3", "164": "매도거래원수량4", "165": "매도거래원수량5",
    "166": "매도거래원별증감1", "167": "매도거래원별증감2", "168": "매도거래원별증감3", "169": "매도거래원별증감4", "170": "매도거래원별증감5",
    "146": "매도거래원코드1", "147": "매도거래원코드2", "148": "매도거래원코드3", "149": "매도거래원코드4", "150": "매도거래원코드5",
    "271": "매도거래원색깔1", "272": "매도거래원색깔2", "273": "매도거래원색깔3", "274": "매도거래원색깔4", "275": "매도거래원색깔5",
    
    # 매수거래원 1~5
    "151": "매수거래원1", "152": "매수거래원2", "153": "매수거래원3", "154": "매수거래원4", "155": "매수거래원5",
    "171": "매수거래원수량1", "172": "매수거래원수량2", "173": "매수거래원수량3", "174": "매수거래원수량4", "175": "매수거래원수량5",
    "176": "매수거래원별증감1", "177": "매수거래원별증감2", "178": "매수거래원별증감3", "179": "매수거래원별증감4", "180": "매수거래원별증감5",
    "156": "매수거래원코드1", "157": "매수거래원코드2", "158": "매수거래원코드3", "159": "매수거래원코드4", "160": "매수거래원코드5",
    "281": "매수거래원색깔1", "282": "매수거래원색깔2", "283": "매수거래원색깔3", "284": "매수거래원색깔4", "285": "매수거래원색깔5",
    
    # 외국계 정보
    "261": "외국계매도추정합", "262": "외국계매도추정합변동", "263": "외국계매수추정합", "264": "외국계매수추정합변동",
    "267": "외국계순매수추정합", "268": "외국계순매수변동",
    
    # 기타
    "337": "거래소구분",
    
    # 0G: ETF NAV 전용 필드들
    "36": "NAV", "37": "NAV전일대비", "38": "NAV등락율", "39": "추적오차율",
    "667": "ELW기어링비율", "668": "ELW손익분기율", "669": "ELW자본지지점",
    "265": "NAV/지수괴리율", "266": "NAV/ETF괴리율",
    
    # 0U: 업종등락 전용 필드들
    "251": "상한종목수", "252": "상승종목수", "253": "보합종목수", "254": "하한종목수", "255": "하락종목수",
    "256": "거래형성종목수", "257": "거래형성비율",
    
    # 0g: 주식종목정보 전용 필드들
    "297": "임의연장", "592": "장전임의연장", "593": "장후임의연장",
    "305": "상한가", "306": "하한가", "307": "기준가",
    "689": "조기종료ELW발생", "594": "통화단위", "382": "증거금율표시", "370": "종목정보",
    
    # 0m: ELW 이론가 전용 필드들
    "670": "ELW이론가", "671": "ELW내재변동성", "672": "ELW델타", "673": "ELW감마",
    "674": "ELW쎄타", "675": "ELW베가", "676": "ELW로", "706": "LP호가내재변동성",
    
    # 0s: 장시작시간 전용 필드들
    "215": "장운영구분", "214": "장시작예상잔여시간",
    
    # 0u: ELW 지표 전용 필드들
    "666": "ELW패리티", "1211": "ELW프리미엄", "667": "ELW기어링비율",
    "668": "ELW손익분기율", "669": "ELW자본지지점",
    
    # 0w: 종목프로그램매매 전용 필드들
    "202": "매도수량", "204": "매도금액", "206": "매수수량", "208": "매수금액",
    "210": "순매수수량", "211": "순매수수량증감", "212": "순매수금액", "213": "순매수금액증감",
    "214": "장시작예상잔여시간", "215": "장운영구분", "216": "투자자별ticker",
    
    # 04: 잔고 전용 필드들
    "930": "보유수량", "931": "매입단가", "932": "총매입가(당일누적)", "933": "주문가능수량",
    "945": "당일순매수량", "946": "매도/매수구분", "950": "당일총매도손익", "951": "Extra Item",
    "8019": "손익률(실현손익)", "957": "신용금액", "958": "신용이자", "918": "만기일",
    "990": "당일실현손익(유가)", "991": "당일실현손익율(유가)", "992": "당일실현손익(신용)", 
    "993": "당일실현손익율(신용)", "959": "담보대출수량", "924": "Extra Item",
    
    # 1h: VI발동/해제 전용 필드들
    "9001": "종목코드", "9068": "VI발동구분", "9008": "KOSPI,KOSDAQ,전체구분", "9075": "장전구분",
    "1221": "VI발동가격", "1223": "매매체결처리시각", "1224": "VI해제시각", "1225": "VI적용구분",
    "1236": "기준가격 정적", "1237": "기준가격 동적", "1238": "괴리율 정적", "1239": "괴리율 동적",
    "1489": "VI발동가 등락율", "1490": "VI발동횟수", "9069": "발동방향구분", "1279": "Extra Item",
    
    # 거래소 관련
    "2134": "거래소구분",
    "2135": "거래소구분명", 
    "2136": "SOR여부",
    
    # 0B: 주식체결 전용 필드들
    "25": "전일대비기호",
    "26": "전일거래량대비(계약,주)",
    "31": "거래회전율",
    "32": "거래비용",
    "228": "체결강도",
    "311": "시가총액(억)",
    "290": "장구분",
    "691": "K.O 접근도",
    "567": "상한가발생시간",
    "568": "하한가발생시간",
    "851": "전일 동시간 거래량 비율",
    "1890": "시가시간",
    "1891": "고가시간",
    "1892": "저가시간",
    "1030": "매도체결량",
    "1031": "매수체결량",
    "1032": "매수비율",
    "1071": "매도체결건수",
    "1072": "매수체결건수",
    "1313": "순간거래대금",
    "1315": "매도체결량_단건",
    "1316": "매수체결량_단건",
    "1314": "순매수체결량",
    "1497": "CFD증거금",
    "1498": "유지증거금",
    "620": "당일거래평균가",
    "732": "CFD거래비용",
    "852": "대주거래비용",
    "9081": "거래소구분",
}


# 필드 타입 정의 (데이터 파싱 시 사용)
FIELD_TYPES: Dict[str, str] = {
    # 숫자형 필드들
    "10": "price",      # 현재가
    "11": "price",      # 전일대비
    "12": "percentage", # 등락률
    "13": "volume",     # 누적거래량
    "14": "amount",     # 누적거래대금
    "15": "volume",     # 거래량
    "16": "price",      # 고가
    "17": "price",      # 저가
    "18": "price",      # 시가
    "27": "price",      # 매도호가
    "28": "price",      # 매수호가
    "29": "amount",     # 거래대금
    "30": "percentage", # 등락율
    "900": "quantity",  # 주문수량
    "901": "price",     # 주문가격
    "902": "quantity",  # 미체결수량
    "903": "amount",    # 체결누계금액
    "910": "price",     # 체결가
    "911": "quantity",  # 체결량
    "914": "price",     # 단위체결가
    "915": "quantity",  # 단위체결량
    "938": "amount",    # 당일매매수수료
    "939": "amount",    # 당일매매세금
    "10010": "price",   # 시간외단일가_현재가
    
    # 시간형 필드들
    "20": "time",       # 체결시간
    "908": "time",      # 주문/체결시간
    "923": "date",      # 대출일
    
    # 문자형 필드들
    "9201": "string",   # 계좌번호
    "9203": "string",   # 주문번호
    "9205": "string",   # 관리자사번
    "9001": "string",   # 종목코드
    "302": "string",    # 종목명
    "912": "string",    # 주문업무분류
    "913": "string",    # 주문상태
    "904": "string",    # 원주문번호
    "905": "string",    # 주문구분
    "906": "string",    # 매매구분
    "907": "string",    # 매도수구분
    "909": "string",    # 체결번호
    "919": "string",    # 거부사유
    "920": "string",    # 화면번호
    "921": "string",    # 터미널번호
    "922": "string",    # 신용구분
    "2134": "string",   # 거래소구분
    "2135": "string",   # 거래소구분명
    "2136": "string",   # SOR여부
    
    # 0B: 주식체결 전용 필드 타입들
    "25": "string",     # 전일대비기호
    "26": "volume",     # 전일거래량대비(계약,주)
    "31": "percentage", # 거래회전율
    "32": "amount",     # 거래비용
    "228": "percentage", # 체결강도
    "311": "amount",    # 시가총액(억)
    "290": "string",    # 장구분
    "691": "string",    # K.O 접근도
    "567": "time",      # 상한가발생시간
    "568": "time",      # 하한가발생시간
    "851": "percentage", # 전일 동시간 거래량 비율
    "1890": "time",     # 시가시간
    "1891": "time",     # 고가시간
    "1892": "time",     # 저가시간
    "1030": "volume",   # 매도체결량
    "1031": "volume",   # 매수체결량
    "1032": "percentage", # 매수비율
    "1071": "quantity", # 매도체결건수
    "1072": "quantity", # 매수체결건수
    "1313": "amount",   # 순간거래대금
    "1315": "volume",   # 매도체결량_단건
    "1316": "volume",   # 매수체결량_단건
    "1314": "volume",   # 순매수체결량
    "1497": "amount",   # CFD증거금
    "1498": "amount",   # 유지증거금
    "620": "price",     # 당일거래평균가
    "732": "amount",    # CFD거래비용
    "852": "amount",    # 대주거래비용
    "9081": "string",   # 거래소구분
}


def get_field_description(field_code: str) -> Optional[str]:
    """필드 코드에 대한 설명 반환"""
    return FIELD_MAPPINGS.get(field_code)


def get_field_type(field_code: str) -> Optional[str]:
    """필드 코드의 데이터 타입 반환"""
    return FIELD_TYPES.get(field_code, "string")


def is_price_field(field_code: str) -> bool:
    """가격 관련 필드인지 확인"""
    return get_field_type(field_code) == "price"


def is_volume_field(field_code: str) -> bool:
    """거래량 관련 필드인지 확인"""
    return get_field_type(field_code) in ["volume", "quantity"]


def is_amount_field(field_code: str) -> bool:
    """금액 관련 필드인지 확인"""
    return get_field_type(field_code) == "amount"


def is_percentage_field(field_code: str) -> bool:
    """비율 관련 필드인지 확인"""
    return get_field_type(field_code) == "percentage"


def is_time_field(field_code: str) -> bool:
    """시간 관련 필드인지 확인"""
    return get_field_type(field_code) in ["time", "date"]


def format_field_value(field_code: str, value: str) -> str:
    """필드 값을 타입에 맞게 포맷팅"""
    if not value:
        return value
        
    field_type = get_field_type(field_code)
    
    try:
        if field_type in ["price", "amount"]:
            # 가격/금액은 정수로 표시 (키움은 원단위)
            return str(int(value))
        elif field_type == "percentage":
            # 비율은 소수점 표시
            return f"{float(value):.2f}"
        elif field_type in ["volume", "quantity"]:
            # 거래량/수량은 정수로 표시
            return str(int(value))
        else:
            # 문자열은 그대로
            return value
    except (ValueError, TypeError):
        # 파싱 실패 시 원본 반환
        return value


def get_readable_data(values: Dict[str, str]) -> Dict[str, str]:
    """필드 코드를 한글명으로 변환하여 가독성 높은 데이터 반환"""
    readable = {}
    for field_code, value in values.items():
        description = get_field_description(field_code)
        formatted_value = format_field_value(field_code, value)
        
        if description:
            readable[f"{description}({field_code})"] = formatted_value
        else:
            readable[field_code] = formatted_value
            
    return readable