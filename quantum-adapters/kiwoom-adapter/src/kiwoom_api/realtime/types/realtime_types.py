"""
키움증권 실시간 시세 타입 정의
18개 실시간 시세 타입을 순차적으로 추가
"""

from typing import Dict, Set
from dataclasses import dataclass


@dataclass
class RealtimeType:
    """실시간 시세 타입 정보"""
    code: str
    name: str
    description: str
    supported_fields: Set[str]


# 현재까지 지원하는 실시간 타입들
REALTIME_TYPES: Dict[str, RealtimeType] = {
    # 첫 번째 제공된 타입
    "00": RealtimeType(
        code="00",
        name="주식호가잔량",
        description="주식 호가와 잔량 정보",
        supported_fields={
            "9201",  # 계좌번호
            "9203",  # 주문번호
            "9205",  # 관리자사번
            "9001",  # 종목코드,업종코드
            "912",   # 주문업무분류
            "913",   # 주문상태
            "302",   # 종목명
            "900",   # 주문수량
            "901",   # 주문가격
            "902",   # 미체결수량
            "903",   # 체결누계금액
            "904",   # 원주문번호
            "905",   # 주문구분
            "906",   # 매매구분
            "907",   # 매도수구분
            "908",   # 주문/체결시간
            "909",   # 체결번호
            "910",   # 체결가
            "911",   # 체결량
            "10",    # 현재가
            "27",    # (최우선)매도호가
            "28",    # (최우선)매수호가
            "914",   # 단위체결가
            "915",   # 단위체결량
            "938",   # 당일매매수수료
            "939",   # 당일매매세금
            "919",   # 거부사유
            "920",   # 화면번호
            "921",   # 터미널번호
            "922",   # 신용구분
            "923",   # 대출일
            "10010", # 시간외단일가_현재가
            "2134",  # 거래소구분
            "2135",  # 거래소구분명
            "2136",  # SOR여부
        }
    ),
    
    # 04: 잔고 (공식 가이드 구현)
    "04": RealtimeType(
        code="04",
        name="잔고",
        description="보유 주식 잔고 및 손익 정보",
        supported_fields={
            "9201",  # 계좌번호
            "9001",  # 종목코드,업종코드
            "917",   # 신용구분
            "916",   # 대출일
            "302",   # 종목명
            "10",    # 현재가
            "930",   # 보유수량
            "931",   # 매입단가
            "932",   # 총매입가(당일누적)
            "933",   # 주문가능수량
            "945",   # 당일순매수량
            "946",   # 매도/매수구분
            "950",   # 당일총매도손익
            "951",   # Extra Item
            "27",    # (최우선)매도호가
            "28",    # (최우선)매수호가
            "307",   # 기준가
            "8019",  # 손익률(실현손익)
            "957",   # 신용금액
            "958",   # 신용이자
            "918",   # 만기일
            "990",   # 당일실현손익(유가)
            "991",   # 당일실현손익율(유가)
            "992",   # 당일실현손익(신용)
            "993",   # 당일실현손익율(신용)
            "959",   # 담보대출수량
            "924",   # Extra Item
        }
    ),
    
    # 0A: 주식기세 (공식 가이드 구현)
    "0A": RealtimeType(
        code="0A",
        name="주식기세",
        description="주식 기세 정보",
        supported_fields={
            "10",    # 현재가
            "11",    # 전일대비
            "12",    # 등락율
            "27",    # (최우선)매도호가
            "28",    # (최우선)매수호가
            "13",    # 누적거래량
            "14",    # 누적거래대금
            "16",    # 시가
            "17",    # 고가
            "18",    # 저가
            "25",    # 전일대비기호
            "26",    # 전일거래량대비(계약,주)
            "29",    # 거래대금증감
            "30",    # 전일거래량대비(비율)
            "31",    # 거래회전율
            "32",    # 거래비용
            "311",   # 시가총액(억)
            "567",   # 상한가발생시간
            "568",   # 하한가발생시간
        }
    ),
    
    # 0C: 주식우선호가 (공식 가이드 구현)
    "0C": RealtimeType(
        code="0C",
        name="주식우선호가",
        description="주식 우선 호가 정보",
        supported_fields={
            "27",    # (최우선)매도호가
            "28",    # (최우선)매수호가
        }
    ),
    
    # 0D: 주식호가잔량 (공식 가이드 완전 구현)
    "0D": RealtimeType(
        code="0D",
        name="주식호가잔량",
        description="주식 호가와 잔량 정보 (상세)",
        supported_fields={
            # 기본 시간 정보
            "21",    # 호가시간
            
            # 매도호가 1~10
            "41", "42", "43", "44", "45", "46", "47", "48", "49", "50",
            
            # 매도호가수량 1~10
            "61", "62", "63", "64", "65", "66", "67", "68", "69", "70",
            
            # 매도호가직전대비 1~10
            "81", "82", "83", "84", "85", "86", "87", "88", "89", "90",
            
            # 매수호가 1~10
            "51", "52", "53", "54", "55", "56", "57", "58", "59", "60",
            
            # 매수호가수량 1~10
            "71", "72", "73", "74", "75", "76", "77", "78", "79", "80",
            
            # 매수호가직전대비 1~10
            "91", "92", "93", "94", "95", "96", "97", "98", "99", "100",
            
            # 호가 총잔량 정보
            "121",   # 매도호가총잔량
            "122",   # 매도호가총잔량직전대비
            "125",   # 매수호가총잔량
            "126",   # 매수호가총잔량직전대비
            
            # 예상체결 정보
            "23",    # 예상체결가
            "24",    # 예상체결수량
            "291",   # 예상체결가 (시간동안만 유효)
            "292",   # 예상체결량
            "293",   # 예상체결가전일대비기호
            "294",   # 예상체결가전일대비
            "295",   # 예상체결가전일대비등락율
            
            # 잔량 및 비율 정보
            "128",   # 순매수잔량
            "129",   # 매수비율
            "138",   # 순매도잔량
            "139",   # 매도비율
            
            # 전일 대비 정보
            "200",   # 예상체결가전일종가대비
            "201",   # 예상체결가전일종가대비등락율
            "238",   # 예상체결가전일종가대비기호
            
            # LP 호가 정보 (1~10)
            "621", "622", "623", "624", "625", "626", "627", "628", "629", "630",  # LP매도호가수량
            "631", "632", "633", "634", "635", "636", "637", "638", "639", "640",  # LP매수호가수량
            
            # 기타 정보
            "13",    # 누적거래량
            "299",   # 전일거래량대비예상체결율
            "215",   # 장운영구분
            "216",   # 투자자별ticker
            
            # KRX 호가잔량 정보 (1~10)
            "6044", "6045", "6046", "6047", "6048", "6049", "6050", "6051", "6052", "6053",  # KRX 매도호가잔량
            "6054", "6055", "6056", "6057", "6058", "6059", "6060", "6061", "6062", "6063",  # KRX 매수호가잔량
            "6064",  # KRX 매도호가총잔량
            "6065",  # KRX 매수호가총잔량
            
            # NXT 호가잔량 정보 (1~10)
            "6066", "6067", "6068", "6069", "6070", "6071", "6072", "6073", "6074", "6075",  # NXT 매도호가잔량
            "6076", "6077", "6078", "6079", "6080", "6081", "6082", "6083", "6084", "6085",  # NXT 매수호가잔량
            "6086",  # NXT 매도호가총잔량
            "6087",  # NXT 매수호가총잔량
            
            # 중간가 정보
            "6100", "6101", "6102", "6103", "6104",  # KRX 중간가 관련
            "6105", "6106", "6107", "6108", "6109",  # NXT 중간가 관련
            "6110", "6111", "6112",  # KRX 중간가대비
            "6113", "6114", "6115",  # NXT 중간가대비
        }
    ),
    
    # 0B: 주식체결 (공식 가이드 완전 구현)
    "0B": RealtimeType(
        code="0B",
        name="주식체결",
        description="주식 체결 정보",
        supported_fields={
            "20",    # 체결시간
            "10",    # 현재가
            "11",    # 전일대비
            "12",    # 등락율
            "27",    # (최우선)매도호가
            "28",    # (최우선)매수호가
            "15",    # 거래량
            "13",    # 누적거래량
            "14",    # 누적거래대금
            "16",    # 시가
            "17",    # 고가
            "18",    # 저가
            "25",    # 전일대비기호
            "26",    # 전일거래량대비(계약,주)
            "29",    # 거래대금증감
            "30",    # 전일거래량대비(비율)
            "31",    # 거래회전율
            "32",    # 거래비용
            "228",   # 체결강도
            "311",   # 시가총액(억)
            "290",   # 장구분
            "691",   # K.O 접근도
            "567",   # 상한가발생시간
            "568",   # 하한가발생시간
            "851",   # 전일 동시간 거래량 비율
            "1890",  # 시가시간
            "1891",  # 고가시간
            "1892",  # 저가시간
            "1030",  # 매도체결량
            "1031",  # 매수체결량
            "1032",  # 매수비율
            "1071",  # 매도체결건수
            "1072",  # 매수체결건수
            "1313",  # 순간거래대금
            "1315",  # 매도체결량_단건
            "1316",  # 매수체결량_단건
            "1314",  # 순매수체결량
            "1497",  # CFD증거금
            "1498",  # 유지증거금
            "620",   # 당일거래평균가
            "732",   # CFD거래비용
            "852",   # 대주거래비용
            "9081",  # 거래소구분
        }
    ),
    
    # 0E: 주식시간외호가 (공식 가이드 구현)
    "0E": RealtimeType(
        code="0E",
        name="주식시간외호가",
        description="주식 시간외 호가 정보",
        supported_fields={
            "21",    # 호가시간
            "131",   # 시간외매도호가총잔량
            "132",   # 시간외매도호가총잔량직전대비
            "135",   # 시간외매수호가총잔량
            "136",   # 시간외매수호가총잔량직전대비
        }
    ),
    
    # 0F: 주식당일거래원 (공식 가이드 구현)
    "0F": RealtimeType(
        code="0F",
        name="주식당일거래원",
        description="주식 당일 거래원별 매매 정보",
        supported_fields={
            # 매도거래원 1~5
            "141", "142", "143", "144", "145",  # 매도거래원 이름
            "161", "162", "163", "164", "165",  # 매도거래원수량
            "166", "167", "168", "169", "170",  # 매도거래원별증감
            "146", "147", "148", "149", "150",  # 매도거래원코드
            "271", "272", "273", "274", "275",  # 매도거래원색깔
            
            # 매수거래원 1~5
            "151", "152", "153", "154", "155",  # 매수거래원 이름
            "171", "172", "173", "174", "175",  # 매수거래원수량
            "176", "177", "178", "179", "180",  # 매수거래원별증감
            "156", "157", "158", "159", "160",  # 매수거래원코드
            "281", "282", "283", "284", "285",  # 매수거래원색깔
            
            # 외국계 정보
            "261",   # 외국계매도추정합
            "262",   # 외국계매도추정합변동
            "263",   # 외국계매수추정합
            "264",   # 외국계매수추정합변동
            "267",   # 외국계순매수추정합
            "268",   # 외국계순매수변동
            
            # 기타
            "337",   # 거래소구분
        }
    ),
    
    # 0G: ETF NAV (공식 가이드 구현)
    "0G": RealtimeType(
        code="0G",
        name="ETF NAV",
        description="ETF 순자산가치 및 관련 정보",
        supported_fields={
            # NAV 정보
            "36",    # NAV
            "37",    # NAV전일대비
            "38",    # NAV등락율
            "39",    # 추적오차율
            
            # 기본 체결 정보
            "20",    # 체결시간
            "10",    # 현재가
            "11",    # 전일대비
            "12",    # 등락율
            "13",    # 누적거래량
            "25",    # 전일대비기호
            
            # ELW 관련 (일부 ETF에 적용)
            "667",   # ELW기어링비율
            "668",   # ELW손익분기율
            "669",   # ELW자본지지점
            
            # 괴리율 정보
            "265",   # NAV/지수괴리율
            "266",   # NAV/ETF괴리율
        }
    ),
    
    # 0H: 주식예상체결 (공식 가이드 구현)
    "0H": RealtimeType(
        code="0H",
        name="주식예상체결",
        description="주식 예상 체결 정보",
        supported_fields={
            "20",    # 체결시간
            "10",    # 현재가
            "11",    # 전일대비
            "12",    # 등락율
            "15",    # 거래량 (+는 매수체결, -는 매도체결)
            "13",    # 누적거래량
            "25",    # 전일대비기호
        }
    ),
    
    # 0J: 업종지수 (공식 가이드 구현)
    "0J": RealtimeType(
        code="0J",
        name="업종지수",
        description="업종별 지수 정보",
        supported_fields={
            "20",    # 체결시간
            "10",    # 현재가 (지수값)
            "11",    # 전일대비
            "12",    # 등락율
            "15",    # 거래량 (+는 매수체결, -는 매도체결)
            "13",    # 누적거래량
            "14",    # 누적거래대금
            "16",    # 시가
            "17",    # 고가
            "18",    # 저가
            "25",    # 전일대비기호
            "26",    # 전일거래량대비 (계약,주)
        }
    ),
    
    # 0U: 업종등락 (공식 가이드 구현)
    "0U": RealtimeType(
        code="0U",
        name="업종등락",
        description="업종별 등락 상세 정보",
        supported_fields={
            "20",    # 체결시간
            "252",   # 상승종목수
            "251",   # 상한종목수
            "253",   # 보합종목수
            "255",   # 하락종목수
            "254",   # 하한종목수
            "13",    # 누적거래량
            "14",    # 누적거래대금
            "10",    # 현재가 (지수값)
            "11",    # 전일대비
            "12",    # 등락율
            "256",   # 거래형성종목수
            "257",   # 거래형성비율
            "25",    # 전일대비기호
        }
    ),
    
    # 0g: 주식종목정보 (공식 가이드 구현)
    "0g": RealtimeType(
        code="0g",
        name="주식종목정보",
        description="주식 종목 기본 정보",
        supported_fields={
            "297",   # 임의연장
            "592",   # 장전임의연장
            "593",   # 장후임의연장
            "305",   # 상한가
            "306",   # 하한가
            "307",   # 기준가
            "689",   # 조기종료ELW발생
            "594",   # 통화단위
            "382",   # 증거금율표시
            "370",   # 종목정보
        }
    ),
    
    # 0m: ELW 이론가 (공식 가이드 구현)
    "0m": RealtimeType(
        code="0m",
        name="ELW 이론가",
        description="ELW 이론가 및 Greeks 정보",
        supported_fields={
            "20",    # 체결시간
            "10",    # 현재가
            "670",   # ELW이론가
            "671",   # ELW내재변동성
            "672",   # ELW델타
            "673",   # ELW감마
            "674",   # ELW쎄타
            "675",   # ELW베가
            "676",   # ELW로
            "706",   # LP호가내재변동성
        }
    ),
    
    # 0s: 장시작시간 (공식 가이드 구현)
    "0s": RealtimeType(
        code="0s",
        name="장시작시간",
        description="시장 개장/폐장 상태 및 시간 정보",
        supported_fields={
            "215",   # 장운영구분
            "20",    # 체결시간
            "214",   # 장시작예상잔여시간
        }
    ),
    
    # 0u: ELW 지표 (공식 가이드 구현)
    "0u": RealtimeType(
        code="0u",
        name="ELW 지표",
        description="ELW 패리티, 프리미엄, 기어링 등 지표 정보",
        supported_fields={
            "20",    # 체결시간
            "666",   # ELW패리티
            "1211",  # ELW프리미엄
            "667",   # ELW기어링비율
            "668",   # ELW손익분기율
            "669",   # ELW자본지지점
        }
    ),
    
    # 0w: 종목프로그램매매 (공식 가이드 구현)
    "0w": RealtimeType(
        code="0w",
        name="종목프로그램매매",
        description="종목별 프로그램매매 실시간 정보",
        supported_fields={
            "20",    # 체결시간
            "10",    # 현재가
            "25",    # 전일대비기호
            "11",    # 전일대비
            "12",    # 등락율
            "13",    # 누적거래량
            "202",   # 매도수량
            "204",   # 매도금액
            "206",   # 매수수량
            "208",   # 매수금액
            "210",   # 순매수수량
            "211",   # 순매수수량증감
            "212",   # 순매수금액
            "213",   # 순매수금액증감
            "214",   # 장시작예상잔여시간
            "215",   # 장운영구분
            "216",   # 투자자별ticker
        }
    ),
    
    # 1h: VI발동/해제 (공식 가이드 구현)
    "1h": RealtimeType(
        code="1h",
        name="VI발동/해제",
        description="변동성 중단 (Volatility Interruption) 발동/해제 정보",
        supported_fields={
            "9001",  # 종목코드
            "302",   # 종목명
            "13",    # 누적거래량
            "14",    # 누적거래대금
            "9068",  # VI발동구분
            "9008",  # KOSPI,KOSDAQ,전체구분
            "9075",  # 장전구분
            "1221",  # VI발동가격
            "1223",  # 매매체결처리시각
            "1224",  # VI해제시각
            "1225",  # VI적용구분
            "1236",  # 기준가격 정적
            "1237",  # 기준가격 동적
            "1238",  # 괴리율 정적
            "1239",  # 괴리율 동적
            "1489",  # VI발동가 등락율
            "1490",  # VI발동횟수
            "9069",  # 발동방향구분
            "1279",  # Extra Item
        }
    ),
}


def get_realtime_type(code: str) -> RealtimeType:
    """실시간 타입 정보 조회"""
    return REALTIME_TYPES.get(code)


def get_supported_types() -> Dict[str, str]:
    """지원하는 실시간 타입 목록 반환"""
    return {code: rt.name for code, rt in REALTIME_TYPES.items()}


def is_supported_type(code: str) -> bool:
    """지원하는 타입인지 확인"""
    return code in REALTIME_TYPES


def validate_type_fields(type_code: str, fields: Set[str]) -> Set[str]:
    """타입에서 지원하지 않는 필드 확인"""
    realtime_type = get_realtime_type(type_code)
    if not realtime_type:
        return fields  # 지원하지 않는 타입이면 모든 필드 반환
    
    return fields - realtime_type.supported_fields


# 키움증권 18개 실시간 타입 전체 목록
ALL_KIWOOM_TYPES = {
    "00": "주문체결",
    "04": "잔고", 
    "0A": "주식기세",
    "0B": "주식체결",
    "0C": "주식우선호가",
    "0D": "주식호가잔량",
    "0E": "주식시간외호가",
    "0F": "주식당일거래원",
    "0G": "ETF NAV",
    "0H": "주식예상체결",
    "0J": "업종지수",
    "0U": "업종등락",
    "0g": "주식종목정보",
    "0m": "ELW 이론가",
    "0s": "장시작시간",
    "0u": "ELW 지표",
    "0w": "종목프로그램매매",
    "1h": "VI발동/해제"
}

# 아직 구현되지 않은 타입들
PENDING_TYPES = [
    # 모든 타입 구현 완료!
]