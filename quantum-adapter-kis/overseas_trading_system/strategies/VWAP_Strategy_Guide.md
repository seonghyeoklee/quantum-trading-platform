# 📊 VWAP (Volume Weighted Average Price) 전략 가이드

## 🎯 VWAP란 무엇인가?

**VWAP (Volume Weighted Average Price)**는 거래량을 가중치로 한 평균 가격으로, **기관 투자자들이 가장 신뢰하는 벤치마크**입니다.

### 간단한 비유
- 일반 평균: 모든 학생의 점수를 똑같이 계산
- VWAP: 수업 참여도(거래량)가 높은 학생의 점수에 더 큰 비중

### 핵심 공식
```
VWAP = Σ(가격 × 거래량) / Σ(거래량)
```

## 🏦 왜 기관투자자들이 VWAP를 사용할까?

### 1. **대량 거래의 기준점**
- 수백만 주를 사야 할 때, 어떤 가격이 공정한가?
- VWAP = 시장에서 실제로 거래된 공정 가격

### 2. **성과 평가 기준**
```
✅ VWAP보다 좋은 가격에 샀다 = 우수한 실행
❌ VWAP보다 비싸게 샀다 = 아쉬운 실행
```

### 3. **시장 충격 최소화**
- VWAP 근처에서 거래 = 시장 가격에 미치는 영향 최소

---

## 🔍 우리가 구현한 VWAP 전략

### 핵심 아이디어
> **"가격이 VWAP에서 너무 멀어지면 다시 돌아올 것이다"**

### 매매 신호
```
📈 매수 신호: 가격이 VWAP 아래 Lower Band 터치
📉 매도 신호: 가격이 VWAP 위 Upper Band 터치
```

## 📈 전략 동작 원리

### Step 1: VWAP 계산 (실시간)
```
09:30 - $100 × 1000주 = $100,000
09:31 - $101 × 2000주 = $202,000
09:32 - $99  × 1500주 = $148,500

총 거래액: $450,500
총 거래량: 4,500주
VWAP = $450,500 ÷ 4,500 = $100.11
```

### Step 2: 밴드 계산
```
Upper Band = VWAP + (2 × 표준편차)  # 과매수 구간
Lower Band = VWAP - (2 × 표준편차)  # 과매도 구간
```

### Step 3: 신호 판단 (7단계 종합 분석)

#### 🔍 1단계: 밴드 위치 확인
```python
if 현재가격 <= Lower Band:
    매수 신호 +0.4점
elif 현재가격 >= Upper Band:
    매도 신호 +0.4점
```

#### 🔍 2단계: 정확도 검증
```python
if 밴드와의 거리 < 0.2%:  # 거의 정확히 터치
    신호 강도 +0.2점 추가
```

#### 🔍 3단계: 회귀 경향 분석
```python
# VWAP 아래에서 위로 향하는 중?
if 가격 < VWAP and 상승_연속:
    매수 신호 +0.15점
```

#### 🔍 4단계: 거래량 급증 확인
```python
if 현재_거래량 > 평균_거래량 × 1.5:
    신호 강화 (거래량만큼 비례)
```

#### 🔍 5단계: RSI 보조 확인
```python
if RSI < 35 and 가격 < VWAP:
    매수 신호 +0.1점  # 과매도 확인
```

#### 🔍 6단계: 거래 시간 가중치
```python
정규장 (9:30-16:00):   100% 신뢰도
프리마켓 (4:00-9:30):   60% 신뢰도
애프터아워스 (16:00-20:00): 40% 신뢰도
```

#### 🔍 7단계: 급락 방어 시스템
```python
if 5분간_하락 > -2%:  # 급락 감지
    매수_신호 × 0.1   # 90% 약화
    포지션_크기 ÷ 2   # 50% 축소
```

---

## 🎮 실전 트레이딩 시나리오

### 시나리오 1: 완벽한 매수 타이밍 ⭐
```
📊 상황:
- 시간: 10:15 AM (정규장)
- 현재가: $98.50
- VWAP: $100.20
- Lower Band: $98.40
- RSI: 28 (과매도)
- 거래량: 평균의 2.1배

🔍 분석:
✅ Lower Band 근처 터치 (+0.4점)
✅ 밴드 정확히 터치 (+0.2점)
✅ RSI 과매도 확인 (+0.1점)
✅ 거래량 급증 (+0.15점)
✅ 정규장 (가중치 1.0)

📈 결과: 매수 신호 (신뢰도 0.85)
```

### 시나리오 2: 급락 방어 발동 🛡️
```
📊 상황:
- 시간: 11:30 AM
- 현재가: $97.80 (5분 전: $101.50)
- 5분간 하락: -3.6%
- Lower Band 터치 중

🔍 분석:
⚠️ 급락 모멘텀 감지 (-3.6% > -2%)
🛡️ 방어 시스템 발동

📉 결과: 매수 신호 억제 (90% 약화)
📉 포지션 크기 50% 축소
```

### 시나리오 3: 프리마켓 신호 무시 ⏰
```
📊 상황:
- 시간: 7:30 AM (프리마켓)
- Upper Band 터치
- 신뢰도 계산: 0.8

🔍 분석:
⏰ 프리마켓 가중치 0.6 적용
📊 최종 신뢰도: 0.8 × 0.6 = 0.48

❌ 결과: 신호 무시 (최소 0.7 필요)
```

---

## ⚙️ 설정 및 파라미터 가이드

### 기본 설정 (균형잡힌 접근)
```python
config = {
    'std_multiplier': 2.0,           # 밴드 폭 (표준편차 2배)
    'volume_threshold': 1.5,         # 거래량 1.5배 이상
    'min_confidence': 0.7,           # 최소 신뢰도 70%
    'min_data_points': 20,           # 최소 데이터 20개

    # 급락 방어 설정
    'enable_crash_protection': True,
    'crash_5min_threshold': -0.02,   # 5분간 -2% 급락
    'risk_threshold_critical': 70    # 리스크 70점 이상
}
```

### 공격적 설정 (빈번한 거래)
```python
config = {
    'std_multiplier': 1.5,           # 좁은 밴드 → 더 많은 신호
    'min_confidence': 0.6,           # 낮은 진입 장벽
    'volume_threshold': 1.2,         # 민감한 거래량 감지
}
```

### 보수적 설정 (안정성 중시)
```python
config = {
    'std_multiplier': 2.5,           # 넓은 밴드 → 확실한 신호만
    'min_confidence': 0.8,           # 높은 진입 장벽
    'crash_5min_threshold': -0.015,  # 더 민감한 급락 감지
}
```

---

## 📊 성과 분석 및 해석

### 실시간 모니터링 지표
```python
# get_current_analysis() 결과 해석
{
    'vwap': 234.56,              # 현재 VWAP
    'upper_band': 238.12,        # 매도 기준선
    'lower_band': 230.99,        # 매수 기준선
    'std_deviation': 3.56,       # 변동성 지표
    'position': 'LOWER',         # 현재 위치
    'data_points': 234           # 누적 데이터
}
```

### 위치별 해석
- **'UPPER'**: 과매수 구간, 매도 고려
- **'MID'**: 중립 구간, 관망
- **'LOWER'**: 과매도 구간, 매수 고려

### 변동성 해석
- **낮은 std_deviation**: 안정적, 밴드 신호 신뢰도 ⬆️
- **높은 std_deviation**: 변동적, 리스크 관리 강화 필요

---

## 💡 실전 활용 팁

### 1. **시장 환경별 대응**
```
📈 상승장: VWAP가 지지선 역할
📉 하락장: VWAP가 저항선 역할
➡️ 횡보장: VWAP 전략 최적 환경
```

### 2. **시간대별 전략**
```
🌅 오전 (9:30-12:00): 데이터 충분, 신뢰도 높음
🌞 오후 (12:00-16:00): 기관 거래 활발, 신호 강화
🌆 시간외: 거래량 부족, 신뢰도 하락
```

### 3. **포지션 관리**
```
높은 신뢰도 (0.8+): 풀 포지션
중간 신뢰도 (0.7-0.8): 절반 포지션
급락 감지 시: 포지션 크기 자동 축소
```

### 4. **다른 지표와 조합**
```
VWAP + RSI: 과매수/과매도 확인
VWAP + 거래량: 신호 강도 검증
VWAP + 이동평균: 트렌드 방향 확인
```

---

## ⚠️ 주의사항 및 리스크

### 전략의 한계
1. **Intraday 전용**: 장기 투자에 부적합
2. **렌지 장세 특화**: 강한 트렌드에서 약함
3. **데이터 의존**: 초반 데이터 부족 시 신뢰도 하락

### 리스크 관리 필수사항
1. **손절매 설정**: VWAP 기준 ±3% 권장
2. **포지션 크기 제한**: 계좌의 10% 이하
3. **급락 시 거래 중단**: 방어 시스템 신뢰

### 피해야 할 상황
- 실적 발표 직전/직후
- 연준 발표 등 중요 이벤트
- 시장 개장 직후 (첫 30분)
- 거래량이 비정상적으로 적은 날

---

## 🚀 고급 활용법

### Multi-Timeframe VWAP
```python
# 5분 VWAP: 단기 신호
# 1시간 VWAP: 중기 트렌드
# 두 신호가 일치할 때 강한 신호
```

### Anchored VWAP
```python
# 실적 발표일부터 계산된 VWAP
# 중요 이벤트 기준으로 새로 시작
```

### Volume Profile 결합
```python
# VWAP + 거래량 프로필
# 가장 많이 거래된 가격대 확인
```

---

## 📱 실행 방법

### 명령어 실행
```bash
# TSLA VWAP 전략 실행
uv run python realtime_trading_log.py --symbol TSLA --strategy vwap

# 사용자 지정 설정으로 실행
uv run python realtime_trading_log.py --symbol AAPL --strategy vwap --config custom_vwap.yaml
```

### 로그 파일 확인
```bash
# 실시간 로그 확인
tail -f logs/trading/signals/TSLA_vwap_signals_YYYYMMDD_HHMMSS.log
```

### 실시간 모니터링 지표
- `risk_score`: 현재 리스크 (0-100)
- `is_crashing`: 급락 감지 여부
- `vwap_position`: VWAP 대비 위치
- `signal_confidence`: 신호 신뢰도

---

## 🎓 학습 자료

### 추천 도서
- "Algorithmic Trading" by Ernie Chan
- "Building Winning Algorithmic Trading Systems" by Kevin Davey

### 추가 학습 개념
- Volume Profile Analysis
- Market Microstructure
- Institutional Trading Patterns

---

## 🔧 문제 해결

### 자주 묻는 질문

**Q: 신호가 너무 적게 나와요**
- `min_confidence` 값을 0.6으로 낮춰보세요
- `std_multiplier`를 1.8로 줄여보세요

**Q: 손실이 자주 발생해요**
- 급락 방어 설정을 더 민감하게 조정하세요
- `crash_5min_threshold`를 -0.015로 설정

**Q: 프리마켓에서 거래하고 싶어요**
- 세션 가중치를 조정하세요 (최대 0.8 권장)
- 하지만 리스크 증가 주의

### 기술 지원
- 코드 관련: `vwap_strategy.py` 파일 참조
- 설정 관련: `base_strategy.py` 참조
- 로깅 관련: `realtime_trading_log.py` 참조

---

*"VWAP 전략은 시장의 심리를 읽는 것입니다. 기관들이 어떻게 움직이는지 이해하면, 더 나은 트레이더가 될 수 있습니다."* 📈