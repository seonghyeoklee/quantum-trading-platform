package com.quantum.core.architecture;

import static com.tngtech.archunit.lang.syntax.ArchRuleDefinition.*;

import com.tngtech.archunit.core.domain.JavaClasses;
import com.tngtech.archunit.core.importer.ClassFileImporter;
import com.tngtech.archunit.library.Architectures;
import org.junit.jupiter.api.DisplayName;
import org.junit.jupiter.api.Test;

/**
 * Hexagonal Architecture (Ports and Adapters) ê²€ì¦ í…ŒìŠ¤íŠ¸
 * 
 * í—¥ì‚¬ê³ ë‚  ì•„í‚¤í…ì²˜ì˜ í•µì‹¬ ì›ì¹™ë“¤ì„ ArchUnitìœ¼ë¡œ ê°•ì œí•œë‹¤:
 * 1. Domain ê³„ì¸µì€ Infrastructureì— ì˜ì¡´í•˜ì§€ ì•ŠìŒ
 * 2. Port ì¸í„°í˜ì´ìŠ¤ëŠ” Adapter êµ¬í˜„ì²´ì— ì˜ì¡´í•˜ì§€ ì•ŠìŒ
 * 3. Application ê³„ì¸µì€ Domainë§Œ ì˜ì¡´
 * 4. InfrastructureëŠ” Domain/Applicationì— ì˜ì¡´í•  ìˆ˜ ìˆì§€ë§Œ ì—­ë°©í–¥ì€ ê¸ˆì§€
 */
@DisplayName("ğŸ—ï¸ Hexagonal Architecture Rules")
class HexagonalArchitectureTest {

    private static final String BASE_PACKAGE = "com.quantum.core";
    private static final JavaClasses classes = new ClassFileImporter()
            .importPackages(BASE_PACKAGE);

    @Test
    @DisplayName("ë ˆì´ì–´ë“œ ì•„í‚¤í…ì²˜ êµ¬ì¡°ê°€ ì˜¬ë°”ë¥´ê²Œ ì •ì˜ë˜ì–´ì•¼ í•œë‹¤")
    void layered_architecture_should_be_respected() {
        Architectures.layeredArchitecture()
                .consideringOnlyDependenciesInLayers()
                .layer("Domain").definedBy("..domain..")
                .layer("Application").definedBy("..application..")
                .layer("Infrastructure").definedBy("..infrastructure..")
                
                .whereLayer("Domain").mayNotAccessAnyLayer()
                .whereLayer("Application").mayOnlyAccessLayers("Domain")
                .whereLayer("Infrastructure").mayAccessLayers("Domain", "Application")
                
                .check(classes);
    }

    @Test
    @DisplayName("ë„ë©”ì¸ ê³„ì¸µì€ ì¸í”„ë¼ìŠ¤íŠ¸ëŸ­ì²˜ ê³„ì¸µì— ì˜ì¡´í•˜ì§€ ì•Šì•„ì•¼ í•œë‹¤")
    void domain_should_not_depend_on_infrastructure() {
        noClasses()
                .that().resideInAPackage("..domain..")
                .should().dependOnClassesThat().resideInAPackage("..infrastructure..")
                .because("ë„ë©”ì¸ ê³„ì¸µì€ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ë§Œ í¬í•¨í•˜ê³  ê¸°ìˆ ì  ì„¸ë¶€ì‚¬í•­ì— ì˜ì¡´í•˜ì§€ ì•Šì•„ì•¼ í•¨")
                .check(classes);
    }

    @Test
    @DisplayName("í¬íŠ¸ ì¸í„°í˜ì´ìŠ¤ëŠ” ì–´ëŒ‘í„° êµ¬í˜„ì²´ì— ì˜ì¡´í•˜ì§€ ì•Šì•„ì•¼ í•œë‹¤")
    void ports_should_not_depend_on_adapters() {
        noClasses()
                .that().resideInAPackage("..domain.port..")
                .should().dependOnClassesThat().resideInAPackage("..infrastructure..")
                .because("í¬íŠ¸ëŠ” ì¸í„°í˜ì´ìŠ¤ë¡œì„œ ì–´ëŒ‘í„° êµ¬í˜„ì²´ì— ì˜ì¡´í•˜ì§€ ì•Šì•„ì•¼ í•¨")
                .check(classes);
    }

    @Test
    @DisplayName("ì• í”Œë¦¬ì¼€ì´ì…˜ ê³„ì¸µì€ ë„ë©”ì¸ ê³„ì¸µë§Œ ì˜ì¡´í•´ì•¼ í•œë‹¤")
    void application_should_only_depend_on_domain() {
        classes()
                .that().resideInAPackage("..application..")
                .should().onlyDependOnClassesThat()
                .resideInAnyPackage(
                        "..domain..",
                        "java..",
                        "org.springframework..",
                        "jakarta..",
                        "com.fasterxml.jackson.."
                )
                .because("ì• í”Œë¦¬ì¼€ì´ì…˜ ê³„ì¸µì€ ë„ë©”ì¸ ê³„ì¸µê³¼ í‘œì¤€ ë¼ì´ë¸ŒëŸ¬ë¦¬ë§Œ ì‚¬ìš©í•´ì•¼ í•¨")
                .check(classes);
    }

    @Test
    @DisplayName("ë„ë©”ì¸ ëª¨ë¸ì€ ìˆœìˆ˜í•œ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ë§Œ í¬í•¨í•´ì•¼ í•œë‹¤")
    void domain_models_should_be_pure() {
        classes()
                .that().resideInAPackage("..domain.model..")
                .should().onlyDependOnClassesThat()
                .resideInAnyPackage(
                        "..domain..",
                        "java..",
                        "jakarta.persistence..",  // JPA ì–´ë…¸í…Œì´ì…˜ í—ˆìš©
                        "jakarta.validation..",   // Validation ì–´ë…¸í…Œì´ì…˜ í—ˆìš©
                        "lombok..",               // Lombok í—ˆìš©
                        "com.fasterxml.jackson.." // JSON ì–´ë…¸í…Œì´ì…˜ í—ˆìš©
                )
                .because("ë„ë©”ì¸ ëª¨ë¸ì€ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ê³¼ í•„ìˆ˜ ê¸°ìˆ  ì–´ë…¸í…Œì´ì…˜ë§Œ ì‚¬ìš©í•´ì•¼ í•¨")
                .check(classes);
    }

    @Test
    @DisplayName("í¬íŠ¸ ì¸í„°í˜ì´ìŠ¤ëŠ” ì¸í„°í˜ì´ìŠ¤ì—¬ì•¼ í•œë‹¤")
    void ports_should_be_interfaces() {
        classes()
                .that().resideInAPackage("..domain.port..")
                .and().areTopLevelClasses()
                .should().beInterfaces()
                .because("í¬íŠ¸ëŠ” ì¸í„°í˜ì´ìŠ¤ë¡œ ì •ì˜ë˜ì–´ êµ¬í˜„ì²´ì™€ ë¶„ë¦¬ë˜ì–´ì•¼ í•¨")
                .check(classes);
    }

    @Test
    @DisplayName("Repository êµ¬í˜„ì²´ëŠ” Infrastructure ê³„ì¸µì— ìˆì–´ì•¼ í•œë‹¤")
    void repository_implementations_should_be_in_infrastructure() {
        classes()
                .that().haveSimpleNameEndingWith("RepositoryImpl")
                .or().haveSimpleNameEndingWith("RepositoryAdapter")
                .should().resideInAPackage("..infrastructure..")
                .because("Repository êµ¬í˜„ì²´ëŠ” ì¸í”„ë¼ìŠ¤íŠ¸ëŸ­ì²˜ ê³„ì¸µì—ì„œ ê¸°ìˆ ì  ì„¸ë¶€ì‚¬í•­ì„ ì²˜ë¦¬í•´ì•¼ í•¨")
                .check(classes);
    }

    @Test
    @DisplayName("Service ì¸í„°í˜ì´ìŠ¤ëŠ” Domain Portì— ì •ì˜ë˜ì–´ì•¼ í•œë‹¤")
    void service_interfaces_should_be_in_domain_ports() {
        classes()
                .that().areInterfaces()
                .and().haveSimpleNameEndingWith("Service")
                .should().resideInAPackage("..domain.port.service..")
                .because("ì„œë¹„ìŠ¤ ì¸í„°í˜ì´ìŠ¤ëŠ” ë„ë©”ì¸ í¬íŠ¸ë¡œ ì •ì˜ë˜ì–´ì•¼ í•¨")
                .check(classes);
    }

    @Test
    @DisplayName("Commandì™€ EventëŠ” Application ê³„ì¸µì— ì •ì˜ë˜ì–´ì•¼ í•œë‹¤")
    void commands_and_events_should_be_in_application_layer() {
        classes()
                .that().haveSimpleNameEndingWith("Command")
                .or().haveSimpleNameEndingWith("Event")
                .should().resideInAPackage("..application..")
                .because("Commandì™€ EventëŠ” ì• í”Œë¦¬ì¼€ì´ì…˜ ê³„ì¸µì˜ ê´€ì‹¬ì‚¬ì„")
                .check(classes);
    }

    @Test
    @DisplayName("Configurationì€ Infrastructure ê³„ì¸µì—ë§Œ ìˆì–´ì•¼ í•œë‹¤")
    void configurations_should_be_in_infrastructure() {
        classes()
                .that().haveSimpleNameEndingWith("Config")
                .or().haveSimpleNameEndingWith("Configuration")
                .should().resideInAPackage("..infrastructure..")
                .because("ê¸°ìˆ ì  ì„¤ì •ì€ ì¸í”„ë¼ìŠ¤íŠ¸ëŸ­ì²˜ ê³„ì¸µì˜ ì±…ì„ì„")
                .check(classes);
    }
}