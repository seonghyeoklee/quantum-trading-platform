package com.quantum.core.architecture;

import static com.tngtech.archunit.lang.syntax.ArchRuleDefinition.*;

import com.tngtech.archunit.core.domain.JavaClasses;
import com.tngtech.archunit.core.importer.ClassFileImporter;
import org.junit.jupiter.api.DisplayName;
import org.junit.jupiter.api.Test;

/**
 * ì „ì²´ í”„ë¡œì íŠ¸ ëª¨ë“ˆê°„ ì˜ì¡´ì„± ê·œì¹™ ê²€ì¦ í…ŒìŠ¤íŠ¸
 * 
 * Quantum Trading System ì „ì²´ ëª¨ë“ˆì˜ ì˜ì¡´ì„± ì›ì¹™ë“¤ì„ ArchUnitìœ¼ë¡œ ê°•ì œí•œë‹¤:
 * 1. ëª¨ë“ˆê°„ ì˜ì¡´ì„± ë°©í–¥ (quantum-coreê°€ ì¤‘ì‹¬)
 * 2. ìˆœí™˜ ì˜ì¡´ì„± ê¸ˆì§€
 * 3. ê° ëª¨ë“ˆì˜ ì±…ì„ ë²”ìœ„ ì¤€ìˆ˜
 * 4. í—¥ì‚¬ê³ ë‚  ì•„í‚¤í…ì²˜ + DDD + Event Sourcing í†µí•© ê·œì¹™
 * 5. ë³´ì•ˆ ë° ì„±ëŠ¥ ê´€ë ¨ ì œì•½ì‚¬í•­
 */
@DisplayName("ğŸŒ Project-Wide Architecture Rules")
class ProjectWideArchitectureTest {

    private static final String BASE_PACKAGE = "com.quantum";
    private static final JavaClasses allClasses = new ClassFileImporter()
            .importPackages(BASE_PACKAGE);

    @Test
    @DisplayName("quantum-coreëŠ” ë‹¤ë¥¸ quantum ëª¨ë“ˆì— ì˜ì¡´í•˜ì§€ ì•Šì•„ì•¼ í•œë‹¤")
    void quantum_core_should_not_depend_on_other_quantum_modules() {
        noClasses()
                .that().resideInAPackage("com.quantum.core..")
                .should().dependOnClassesThat().resideInAnyPackage(
                        "com.quantum.api..",
                        "com.quantum.batch..",
                        "com.quantum.kis..",
                        "com.quantum.analysis.."
                )
                .because("quantum-coreëŠ” í•µì‹¬ ë„ë©”ì¸ìœ¼ë¡œì„œ ë‹¤ë¥¸ ëª¨ë“ˆì— ì˜ì¡´í•˜ì§€ ì•Šì•„ì•¼ í•¨")
                .check(allClasses);
    }

    @Test
    @DisplayName("quantum-apiëŠ” quantum-coreì™€ quantum-kisì—ë§Œ ì˜ì¡´í•´ì•¼ í•œë‹¤")
    void quantum_api_should_only_depend_on_core_and_kis() {
        classes()
                .that().resideInAPackage("com.quantum.api..")
                .should().onlyDependOnClassesThat()
                .resideInAnyPackage(
                        "com.quantum.api..",
                        "com.quantum.core..",
                        "com.quantum.kis..",  // KIS API í´ë¼ì´ì–¸íŠ¸ í—ˆìš©
                        "java..",
                        "org.springframework..",
                        "io.swagger..",
                        "lombok..",
                        "jakarta..",
                        "com.fasterxml.jackson.."
                )
                .because("quantum-apiëŠ” coreì™€ kis ëª¨ë“ˆì—ë§Œ ì˜ì¡´í•´ì•¼ í•¨")
                .check(allClasses);
    }

    @Test
    @DisplayName("quantum-batchëŠ” quantum-coreì™€ quantum-kisì—ë§Œ ì˜ì¡´í•´ì•¼ í•œë‹¤")
    void quantum_batch_should_only_depend_on_core_and_kis() {
        classes()
                .that().resideInAPackage("com.quantum.batch..")
                .should().onlyDependOnClassesThat()
                .resideInAnyPackage(
                        "com.quantum.batch..",
                        "com.quantum.core..",
                        "com.quantum.kis..",  // KIS API í´ë¼ì´ì–¸íŠ¸ í—ˆìš©
                        "java..",
                        "org.springframework..",
                        "org.quartz..",
                        "lombok..",
                        "jakarta..",
                        "com.fasterxml.jackson.."
                )
                .because("quantum-batchëŠ” coreì™€ kis ëª¨ë“ˆì—ë§Œ ì˜ì¡´í•´ì•¼ í•¨")
                .check(allClasses);
    }

    @Test
    @DisplayName("quantum-kis ì–´ëŒ‘í„°ëŠ” ì ì ˆí•œ ëª¨ë“ˆ ì˜ì¡´ì„±ì„ ê°€ì ¸ì•¼ í•œë‹¤")
    void quantum_kis_should_have_appropriate_dependencies() {
        classes()
                .that().resideInAPackage("com.quantum.kis..")
                .should().onlyDependOnClassesThat()
                .resideInAnyPackage(
                        "com.quantum.kis..",
                        "java..",
                        "org.springframework..",
                        "feign..",
                        "lombok..",
                        "jakarta..",
                        "com.fasterxml.jackson.."
                )
                .because("quantum-kisëŠ” ì™¸ë¶€ API ì–´ëŒ‘í„°ë¡œì„œ ìµœì†Œí•œì˜ ì˜ì¡´ì„±ë§Œ ê°€ì ¸ì•¼ í•¨")
                .check(allClasses);
    }

    @Test
    @DisplayName("ëª¨ë“  ëª¨ë“ˆì€ ìˆœí™˜ ì˜ì¡´ì„±ì„ ê°€ì§€ì§€ ì•Šì•„ì•¼ í•œë‹¤")
    void all_modules_should_not_have_circular_dependencies() {
        // quantum-api â†’ quantum-batch ê¸ˆì§€
        noClasses()
                .that().resideInAPackage("com.quantum.api..")
                .should().dependOnClassesThat().resideInAPackage("com.quantum.batch..")
                .because("API ëª¨ë“ˆì€ ë°°ì¹˜ ëª¨ë“ˆì— ì˜ì¡´í•˜ì§€ ì•Šì•„ì•¼ í•¨");

        // quantum-batch â†’ quantum-api ê¸ˆì§€
        noClasses()
                .that().resideInAPackage("com.quantum.batch..")
                .should().dependOnClassesThat().resideInAPackage("com.quantum.api..")
                .because("ë°°ì¹˜ ëª¨ë“ˆì€ API ëª¨ë“ˆì— ì˜ì¡´í•˜ì§€ ì•Šì•„ì•¼ í•¨");

        // quantum-kis â†’ quantum-api/batch ê¸ˆì§€
        noClasses()
                .that().resideInAPackage("com.quantum.kis..")
                .should().dependOnClassesThat().resideInAnyPackage(
                        "com.quantum.api..",
                        "com.quantum.batch.."
                )
                .because("ì–´ëŒ‘í„° ëª¨ë“ˆì€ ë‹¤ë¥¸ ì• í”Œë¦¬ì¼€ì´ì…˜ ëª¨ë“ˆì— ì˜ì¡´í•˜ì§€ ì•Šì•„ì•¼ í•¨")
                .check(allClasses);
    }

    @Test
    @DisplayName("ë„ë©”ì¸ ëª¨ë¸ì€ ëª¨ë“  ëª¨ë“ˆì—ì„œ ê³µìœ  ê°€ëŠ¥í•´ì•¼ í•œë‹¤")
    void domain_models_should_be_shareable_across_modules() {
        classes()
                .that().resideInAPackage("com.quantum.core.domain.model..")
                .should().onlyDependOnClassesThat()
                .resideInAnyPackage(
                        "com.quantum.core.domain..",
                        "java..",
                        "jakarta.persistence..",
                        "jakarta.validation..",
                        "lombok..",
                        "com.fasterxml.jackson.."
                )
                .because("ë„ë©”ì¸ ëª¨ë¸ì€ ìˆœìˆ˜í•´ì•¼ í•˜ê³  ë‹¤ë¥¸ ëª¨ë“ˆì—ì„œ ì•ˆì „í•˜ê²Œ ì‚¬ìš©í•  ìˆ˜ ìˆì–´ì•¼ í•¨")
                .check(allClasses);
    }

    @Test
    @DisplayName("Event Sourcing ì»´í¬ë„ŒíŠ¸ëŠ” ì˜¬ë°”ë¥¸ ëª¨ë“ˆ ë°°ì¹˜ë¥¼ ê°€ì ¸ì•¼ í•œë‹¤")
    void event_sourcing_components_should_have_correct_module_placement() {
        // Event Store ì¸í„°í˜ì´ìŠ¤ëŠ” coreì—
        classes()
                .that().haveSimpleName("EventStore")
                .and().areInterfaces()
                .should().resideInAPackage("com.quantum.core.domain.port.eventsourcing..")
                .because("Event Store ì¸í„°í˜ì´ìŠ¤ëŠ” core ë„ë©”ì¸ì— ìˆì–´ì•¼ í•¨");

        // Event Store êµ¬í˜„ì²´ëŠ” core infrastructureì—
        classes()
                .that().haveSimpleNameContaining("EventStore")
                .and().areNotInterfaces()
                .should().resideInAPackage("com.quantum.core.infrastructure.eventsourcing..")
                .because("Event Store êµ¬í˜„ì²´ëŠ” core infrastructureì— ìˆì–´ì•¼ í•¨")
                .check(allClasses);
    }

    @Test
    @DisplayName("Configuration í´ë˜ìŠ¤ëŠ” ì ì ˆí•œ ëª¨ë“ˆì— ë°°ì¹˜ë˜ì–´ì•¼ í•œë‹¤")
    void configuration_classes_should_be_in_appropriate_modules() {
        // API ê´€ë ¨ ì„¤ì •ì€ quantum-apiì—
        classes()
                .that().haveSimpleNameMatching(".*Web.*Config.*|.*Swagger.*Config.*|.*Security.*Config.*")
                .should().resideInAPackage("com.quantum.api..")
                .because("Web/API ê´€ë ¨ ì„¤ì •ì€ quantum-api ëª¨ë“ˆì— ìˆì–´ì•¼ í•¨");

        // ë°°ì¹˜ ê´€ë ¨ ì„¤ì •ì€ quantum-batchì—
        classes()
                .that().haveSimpleNameMatching(".*Batch.*Config.*|.*Quartz.*Config.*|.*Scheduler.*Config.*")
                .should().resideInAPackage("com.quantum.batch..")
                .because("ë°°ì¹˜ ê´€ë ¨ ì„¤ì •ì€ quantum-batch ëª¨ë“ˆì— ìˆì–´ì•¼ í•¨");

        // KIS API ê´€ë ¨ ì„¤ì •ì€ quantum-kisì—
        classes()
                .that().haveSimpleNameMatching(".*Kis.*Config.*|.*Feign.*Config.*|.*RateLimit.*Config.*")
                .should().resideInAPackage("com.quantum.kis..")
                .because("KIS API ê´€ë ¨ ì„¤ì •ì€ quantum-kis ëª¨ë“ˆì— ìˆì–´ì•¼ í•¨")
                .check(allClasses);
    }

    @Test
    @DisplayName("ë°ì´í„°ë² ì´ìŠ¤ ê´€ë ¨ ì–´ë…¸í…Œì´ì…˜ì€ ì ì ˆíˆ ì‚¬ìš©ë˜ì–´ì•¼ í•œë‹¤")
    void database_annotations_should_be_used_appropriately() {
        // JPA EntityëŠ” core ë„ë©”ì¸ì—ë§Œ
        classes()
                .that().areAnnotatedWith("jakarta.persistence.Entity")
                .should().resideInAPackage("com.quantum.core.domain.model..")
                .because("JPA EntityëŠ” core ë„ë©”ì¸ ëª¨ë¸ì—ë§Œ ìˆì–´ì•¼ í•¨");

        // Repository ì¸í„°í˜ì´ìŠ¤ëŠ” core portì—
        classes()
                .that().haveSimpleNameEndingWith("Repository")
                .and().areInterfaces()
                .should().resideInAPackage("com.quantum.core.domain.port.repository..")
                .because("Repository ì¸í„°í˜ì´ìŠ¤ëŠ” core portì— ìˆì–´ì•¼ í•¨");

        // Repository êµ¬í˜„ì²´ëŠ” core infrastructureì—
        classes()
                .that().haveSimpleNameEndingWith("Repository")
                .and().areNotInterfaces()
                .should().resideInAPackage("com.quantum.core.infrastructure..")
                .because("Repository êµ¬í˜„ì²´ëŠ” core infrastructureì— ìˆì–´ì•¼ í•¨")
                .check(allClasses);
    }

    @Test
    @DisplayName("ë³´ì•ˆ ì •ë³´ëŠ” ì–´ë–¤ ëª¨ë“ˆì—ë„ í•˜ë“œì½”ë”©ë˜ì§€ ì•Šì•„ì•¼ í•œë‹¤")
    void security_information_should_not_be_hardcoded_in_any_module() {
        noClasses()
                .that().resideInAPackage("com.quantum..")
                .should().haveFieldThat(field -> {
                    String fieldName = field.getName().toLowerCase();
                    return fieldName.contains("password") ||
                           fieldName.contains("secret") ||
                           fieldName.contains("key") ||
                           fieldName.contains("token");
                })
                .because("ë³´ì•ˆ ì •ë³´ëŠ” ì–´ë–¤ ëª¨ë“ˆì—ë„ í•˜ë“œì½”ë”©ë˜ì§€ ì•Šì•„ì•¼ í•¨")
                .check(allClasses);
    }

    @Test
    @DisplayName("ì™¸ë¶€ API ì˜ì¡´ì„±ì€ ì–´ëŒ‘í„° ëª¨ë“ˆì—ë§Œ ìˆì–´ì•¼ í•œë‹¤")
    void external_api_dependencies_should_only_be_in_adapter_modules() {
        noClasses()
                .that().resideInAnyPackage(
                        "com.quantum.core..",
                        "com.quantum.api..",
                        "com.quantum.batch.."
                )
                .should().dependOnClassesThat().resideInAnyPackage(
                        "feign..",
                        "retrofit..",
                        "okhttp3.."
                )
                .because("ì™¸ë¶€ API ì˜ì¡´ì„±ì€ ì–´ëŒ‘í„° ëª¨ë“ˆì—ë§Œ ìˆì–´ì•¼ í•¨")
                .check(allClasses);
    }

    @Test
    @DisplayName("ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì€ core ëª¨ë“ˆì—ë§Œ ìˆì–´ì•¼ í•œë‹¤")
    void business_logic_should_only_be_in_core_module() {
        classes()
                .that().haveSimpleNameEndingWith("DomainService")
                .or().haveSimpleNameEndingWith("BusinessService")
                .should().resideInAPackage("com.quantum.core.domain.service..")
                .because("ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì€ core ë„ë©”ì¸ ì„œë¹„ìŠ¤ì—ë§Œ ìˆì–´ì•¼ í•¨")
                .check(allClasses);
    }

    @Test
    @DisplayName("ì „ì²´ í”„ë¡œì íŠ¸ì—ì„œ ì¼ê´€ëœ ì½”ë”© ìŠ¤íƒ€ì¼ì„ ì‚¬ìš©í•´ì•¼ í•œë‹¤")
    void entire_project_should_use_consistent_coding_style() {
        // Controller ë„¤ì´ë°
        classes()
                .that().areAnnotatedWith("org.springframework.web.bind.annotation.RestController")
                .should().haveSimpleNameEndingWith("Controller")
                .because("RestControllerëŠ” Controllerë¡œ ëë‚˜ì•¼ í•¨");

        // Service ë„¤ì´ë°
        classes()
                .that().areAnnotatedWith("org.springframework.stereotype.Service")
                .should().haveSimpleNameEndingWith("Service")
                .because("ServiceëŠ” Serviceë¡œ ëë‚˜ì•¼ í•¨");

        // Configuration ë„¤ì´ë°
        classes()
                .that().areAnnotatedWith("org.springframework.context.annotation.Configuration")
                .should().haveSimpleNameEndingWith("Config")
                .orShould().haveSimpleNameEndingWith("Configuration")
                .because("Configurationì€ Config ë˜ëŠ” Configurationìœ¼ë¡œ ëë‚˜ì•¼ í•¨")
                .check(allClasses);
    }

    @Test
    @DisplayName("í…ŒìŠ¤íŠ¸ ì½”ë“œëŠ” ì ì ˆí•œ íŒ¨í‚¤ì§€ êµ¬ì¡°ë¥¼ ê°€ì ¸ì•¼ í•œë‹¤")
    void test_code_should_have_appropriate_package_structure() {
        classes()
                .that().haveSimpleNameEndingWith("Test")
                .should().resideInAPackage("..test..")
                .because("í…ŒìŠ¤íŠ¸ í´ë˜ìŠ¤ëŠ” test íŒ¨í‚¤ì§€ì— ìˆì–´ì•¼ í•¨")
                .check(allClasses);
    }
}