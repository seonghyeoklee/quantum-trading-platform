package com.quantum.core.architecture;

import static com.tngtech.archunit.lang.syntax.ArchRuleDefinition.*;

import com.tngtech.archunit.core.domain.JavaClasses;
import com.tngtech.archunit.core.importer.ClassFileImporter;
import org.junit.jupiter.api.DisplayName;
import org.junit.jupiter.api.Test;

/**
 * ëª¨ë“ˆê°„ ì˜ì¡´ì„± ê·œì¹™ ê²€ì¦ í…ŒìŠ¤íŠ¸
 * 
 * Quantum Trading Systemì˜ ëª¨ë“ˆê°„ ì˜ì¡´ì„± ì›ì¹™ë“¤ì„ ArchUnitìœ¼ë¡œ ê°•ì œí•œë‹¤:
 * 1. quantum-core â†’ ì™¸ë¶€ ë¼ì´ë¸ŒëŸ¬ë¦¬ë§Œ í—ˆìš©
 * 2. quantum-api â†’ quantum-coreë§Œ í—ˆìš©  
 * 3. quantum-batch â†’ quantum-coreë§Œ í—ˆìš©
 * 4. quantum-adapter â†’ quantum-coreë§Œ í—ˆìš© (ìµœê·¼ ìˆ˜ì •ëœ ë¶€ë¶„)
 * 5. ìˆœí™˜ ì˜ì¡´ì„± ê¸ˆì§€
 */
@DisplayName("ğŸ”— Module Dependency Rules")
class ModuleDependencyTest {

    private static final String BASE_PACKAGE = "com.quantum";
    private static final JavaClasses classes = new ClassFileImporter()
            .importPackages(BASE_PACKAGE);

    @Test
    @DisplayName("quantum-coreëŠ” ë‹¤ë¥¸ quantum ëª¨ë“ˆì— ì˜ì¡´í•˜ì§€ ì•Šì•„ì•¼ í•œë‹¤")
    void quantum_core_should_not_depend_on_other_quantum_modules() {
        noClasses()
                .that().resideInAPackage("com.quantum.core..")
                .should().dependOnClassesThat().resideInAnyPackage(
                        "com.quantum.api..",
                        "com.quantum.batch..",
                        "com.quantum.adapter..",
                        "com.quantum.analysis.."
                )
                .because("quantum-coreëŠ” í•µì‹¬ ë„ë©”ì¸ìœ¼ë¡œì„œ ë‹¤ë¥¸ ëª¨ë“ˆì— ì˜ì¡´í•˜ì§€ ì•Šì•„ì•¼ í•¨")
                .check(classes);
    }

    @Test
    @DisplayName("quantum-coreëŠ” Spring Frameworkì—ë§Œ ì œí•œì ìœ¼ë¡œ ì˜ì¡´í•´ì•¼ í•œë‹¤")
    void quantum_core_should_have_limited_spring_dependencies() {
        classes()
                .that().resideInAPackage("com.quantum.core.domain..")
                .should().onlyDependOnClassesThat()
                .resideInAnyPackage(
                        "java..",
                        "jakarta.persistence..",
                        "jakarta.validation..",
                        "lombok..",
                        "com.fasterxml.jackson..",
                        "com.quantum.core..",
                        "org.springframework.context..",     // @EventListener ë“±
                        "org.springframework.stereotype.."   // @Component ë“±
                )
                .because("ë„ë©”ì¸ ê³„ì¸µì€ Springì— ìµœì†Œí•œìœ¼ë¡œë§Œ ì˜ì¡´í•´ì•¼ í•¨")
                .check(classes);
    }

    @Test
    @DisplayName("Infrastructure ê³„ì¸µë§Œ JPA êµ¬í˜„ì²´ì— ì˜ì¡´í•  ìˆ˜ ìˆë‹¤")
    void only_infrastructure_should_depend_on_jpa_implementations() {
        noClasses()
                .that().resideOutsideOfPackage("..infrastructure..")
                .should().dependOnClassesThat().resideInAnyPackage(
                        "org.hibernate..",
                        "org.springframework.data.jpa..",
                        "org.springframework.orm.."
                )
                .because("JPA êµ¬í˜„ì²´ ì˜ì¡´ì„±ì€ ì¸í”„ë¼ìŠ¤íŠ¸ëŸ­ì²˜ ê³„ì¸µì—ë§Œ í—ˆìš©ë¨")
                .check(classes);
    }

    @Test
    @DisplayName("Application ê³„ì¸µì€ ì™¸ë¶€ API í´ë¼ì´ì–¸íŠ¸ì— ì˜ì¡´í•˜ì§€ ì•Šì•„ì•¼ í•œë‹¤")
    void application_layer_should_not_depend_on_external_api_clients() {
        noClasses()
                .that().resideInAPackage("..application..")
                .should().dependOnClassesThat().resideInAnyPackage(
                        "feign..",
                        "retrofit..",
                        "okhttp..",
                        "org.springframework.web.client..",
                        "org.springframework.webflux.."
                )
                .because("ì• í”Œë¦¬ì¼€ì´ì…˜ ê³„ì¸µì€ ì™¸ë¶€ API í´ë¼ì´ì–¸íŠ¸ì— ì§ì ‘ ì˜ì¡´í•˜ì§€ ì•Šì•„ì•¼ í•¨")
                .check(classes);
    }

    @Test
    @DisplayName("Event Sourcing êµ¬í˜„ì²´ëŠ” Infrastructureì—ë§Œ ìˆì–´ì•¼ í•œë‹¤")
    void event_sourcing_implementations_should_be_in_infrastructure() {
        classes()
                .that().haveSimpleNameContaining("EventStore")
                .and().areNotInterfaces()
                .or().haveSimpleNameContaining("Headspring")
                .and().areNotInterfaces()
                .should().resideInAPackage("..infrastructure.eventsourcing..")
                .because("Event Sourcing êµ¬í˜„ì²´ëŠ” ì¸í”„ë¼ìŠ¤íŠ¸ëŸ­ì²˜ì˜ ê´€ì‹¬ì‚¬ì„")
                .check(classes);
    }

    @Test
    @DisplayName("KIS API ê´€ë ¨ í´ë˜ìŠ¤ëŠ” ì ì ˆí•œ íŒ¨í‚¤ì§€ì— ìˆì–´ì•¼ í•œë‹¤")
    void kis_api_classes_should_be_in_appropriate_packages() {
        classes()
                .that().haveSimpleNameStartingWith("Kis")
                .and().resideInAPackage("com.quantum.core..")
                .should().resideInAnyPackage(
                        "..domain.model.kis..",
                        "..infrastructure.repository.."
                )
                .because("KIS ê´€ë ¨ í´ë˜ìŠ¤ëŠ” ë„ë©”ì¸ ëª¨ë¸ì´ë‚˜ ì¸í”„ë¼ Repositoryì—ë§Œ ìˆì–´ì•¼ í•¨")
                .check(classes);
    }

    @Test
    @DisplayName("Configurationì€ Infrastructureì—ë§Œ ìˆì–´ì•¼ í•œë‹¤")
    void configurations_should_only_be_in_infrastructure() {
        classes()
                .that().areAnnotatedWith("org.springframework.context.annotation.Configuration")
                .or().haveSimpleNameEndingWith("Config")
                .or().haveSimpleNameEndingWith("Configuration")
                .should().resideInAPackage("..infrastructure.config..")
                .because("Spring Configurationì€ ì¸í”„ë¼ìŠ¤íŠ¸ëŸ­ì²˜ì˜ ê´€ì‹¬ì‚¬ì„")
                .check(classes);
    }

    @Test
    @DisplayName("Test í´ë˜ìŠ¤ëŠ” ê°™ì€ íŒ¨í‚¤ì§€ êµ¬ì¡°ë¥¼ ë”°ë¼ì•¼ í•œë‹¤")
    void test_classes_should_follow_same_package_structure() {
        classes()
                .that().haveSimpleNameEndingWith("Test")
                .should().resideInAPackage("..test..")
                .because("í…ŒìŠ¤íŠ¸ í´ë˜ìŠ¤ëŠ” í…ŒìŠ¤íŠ¸ íŒ¨í‚¤ì§€ì— ìˆì–´ì•¼ í•¨")
                .check(classes);
    }

    @Test
    @DisplayName("Batch ê´€ë ¨ ì–´ë…¸í…Œì´ì…˜ì€ ê¸ˆì§€ë˜ì–´ì•¼ í•œë‹¤")
    void batch_annotations_should_be_forbidden_in_core() {
        noClasses()
                .that().resideInAPackage("com.quantum.core..")
                .should().beAnnotatedWith("org.springframework.batch.core.configuration.annotation.EnableBatchProcessing")
                .orShould().dependOnClassesThat().resideInAnyPackage("org.springframework.batch..")
                .because("Batch ê´€ë ¨ ì˜ì¡´ì„±ì€ quantum-batch ëª¨ë“ˆì—ë§Œ ìˆì–´ì•¼ í•¨")
                .check(classes);
    }

    @Test
    @DisplayName("Web ê´€ë ¨ ì–´ë…¸í…Œì´ì…˜ì€ ê¸ˆì§€ë˜ì–´ì•¼ í•œë‹¤")
    void web_annotations_should_be_forbidden_in_core() {
        noClasses()
                .that().resideInAPackage("com.quantum.core..")
                .should().beAnnotatedWith("org.springframework.web.bind.annotation.RestController")
                .orShould().beAnnotatedWith("org.springframework.web.bind.annotation.Controller")
                .orShould().beAnnotatedWith("org.springframework.web.bind.annotation.RequestMapping")
                .because("Web ê´€ë ¨ ì–´ë…¸í…Œì´ì…˜ì€ quantum-api ëª¨ë“ˆì—ë§Œ ìˆì–´ì•¼ í•¨")
                .check(classes);
    }

    @Test
    @DisplayName("ì™¸ë¶€ API Client ì˜ì¡´ì„±ì€ ê¸ˆì§€ë˜ì–´ì•¼ í•œë‹¤")
    void external_api_client_dependencies_should_be_forbidden_in_core() {
        noClasses()
                .that().resideInAPackage("com.quantum.core..")
                .should().dependOnClassesThat().resideInAnyPackage(
                        "feign..",
                        "com.quantum.kis.."  // ì´ì œ quantum-adapterë¡œ ë¶„ë¦¬ë¨
                )
                .because("ì™¸ë¶€ API í´ë¼ì´ì–¸íŠ¸ ì˜ì¡´ì„±ì€ quantum-adapter ëª¨ë“ˆì—ë§Œ ìˆì–´ì•¼ í•¨")
                .check(classes);
    }

    @Test
    @DisplayName("Domain EventëŠ” ì˜¬ë°”ë¥¸ ë„¤ì´ë° ê·œì¹™ì„ ë”°ë¼ì•¼ í•œë‹¤")
    void domain_events_should_follow_naming_conventions() {
        classes()
                .that().resideInAPackage("..application.event..")
                .and().haveSimpleNameEndingWith("Event")
                .should().haveSimpleNameMatching(".*Event$")
                .andShould().haveSimpleNameMatching("^[A-Z][a-zA-Z]*Event$")
                .because("Domain EventëŠ” ëª…í™•í•œ ë„¤ì´ë° ê·œì¹™ì„ ë”°ë¼ì•¼ í•¨")
                .check(classes);
    }

    @Test
    @DisplayName("Repository êµ¬í˜„ì²´ëŠ” ì˜¬ë°”ë¥¸ ë„¤ì´ë°ì„ ì‚¬ìš©í•´ì•¼ í•œë‹¤")
    void repository_implementations_should_use_correct_naming() {
        classes()
                .that().resideInAPackage("..infrastructure.repository..")
                .and().areNotInterfaces()
                .should().haveSimpleNameEndingWith("RepositoryImpl")
                .orShould().haveSimpleNameEndingWith("RepositoryAdapter")
                .orShould().haveSimpleNameEndingWith("JpaRepository")
                .because("Repository êµ¬í˜„ì²´ëŠ” ëª…í™•í•œ ë„¤ì´ë°ì„ ì‚¬ìš©í•´ì•¼ í•¨")
                .check(classes);
    }
}