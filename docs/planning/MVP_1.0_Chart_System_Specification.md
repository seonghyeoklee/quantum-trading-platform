# MVP 1.0 차트 시스템 기획서

## 개요

키움 증권 모바일 차트 UI를 참고한 자동매매 플랫폼용 차트 시스템 MVP 버전

### 목표
- 로그인 후 실시간 주식 차트 제공
- 자동매매 판단용 핵심 지표 표시
- 키움 스타일의 친숙한 사용자 인터페이스

## 화면 구성 및 레이아웃

### 전체 화면 구조 (키움 스타일 참고)

```
┌─────────────────────────────────────┐
│ [←] 삼성전자 005930      [검색] [⋯]   │  ← 상단 헤더
│ 69,000 ▲1,400 +2.07%  거래량 표시   │  ← 현재가 정보바  
├─────────────────────────────────────┤
│ [국내][해외] [일][주][월][분][저][%] │  ← 시장/차트 타입 탭바
├─────────────────────────────────────┤
│                                     │
│         캔들스틱 차트                │
│       + 이동평균선 3개               │  ← 메인 차트 영역
│       + 우측 가격축                 │
│                                     │
├─────────────────────────────────────┤
│        거래량 바 차트                │  ← 거래량 차트 영역
│      (상승-빨강/하락-파랑)           │
└─────────────────────────────────────┘
```

### 컴포넌트별 상세 설계

#### 1. 상단 헤더 (Header Component)
**표시 정보**
- 종목명 + 종목코드 (예: 삼성전자 005930)
- 뒤로가기 버튼
- 종목 검색 버튼
- 설정 메뉴 (⋯)

**기능**
- 종목 검색 팝업 호출
- 이전 페이지로 돌아가기
- 차트 설정 옵션

#### 2. 현재가 정보바 (PriceInfo Component)
**표시 정보**
- 현재가: 69,000원 (큰 폰트)
- 전일대비: ▲1,400원 (+2.07%) - 색상 구분
- 거래량: 8,363,215주
- 거래대금: 표시 여부 선택적

**색상 규칙**
- 상승: 빨간색 (#FF0000)
- 하락: 파란색 (#0000FF)  
- 보합: 검은색 (#000000)

#### 3. 탭바 (TabBar Component)
**시장 구분 탭**
- [국내] / [해외] 토글 버튼
- 선택된 탭 하이라이트 표시

**차트 타입 탭**
- [일] [주] [월] [분] [봉] [저] [%]
- MVP에서는 [일] 차트만 구현
- 향후 확장을 위한 UI 구조

#### 4. 메인 차트 (MainChart Component)
**캔들스틱 차트**
- 상승 캔들: 빨간색 (속이 빈 캔들 또는 양봉)
- 하락 캔들: 파란색 (속이 찬 캔들 또는 음봉)
- 보합 캔들: 검은색 가는선

**이동평균선 3개**
- 5일선: 분홍색 (#FF69B4) 가는선
- 20일선: 노란색 (#FFD700) 중간선  
- 60일선: 흰색 (#FFFFFF) 굵은선

**가격축 (우측)**
- 현재가 레벨 표시: 빨간 점선
- 주요 가격 레벨: 58,000 ~ 74,000원 구간
- 자동 스케일링

#### 5. 거래량 차트 (VolumeChart Component)
**거래량 바**
- 상승일 거래량: 빨간 바
- 하락일 거래량: 파란 바
- 최대 거래량 기준 정규화

**거래량축 (우측)**
- 천주 단위 표시: 40,000K
- 메인 차트와 X축 동기화

## 필수 데이터 구조

### 차트 데이터 인터페이스

```typescript
interface ChartData {
  symbol: string;           // 종목코드
  symbolName: string;       // 종목명
  market: 'domestic' | 'overseas';
  data: CandleData[];
}

interface CandleData {
  date: string;            // YYYY-MM-DD
  open: number;            // 시가
  high: number;            // 고가
  low: number;             // 저가
  close: number;           // 종가
  volume: number;          // 거래량
  amount?: number;         // 거래대금 (선택적)
}

interface CurrentPrice {
  symbol: string;
  price: number;           // 현재가
  change: number;          // 전일대비
  changePercent: number;   // 등락률
  volume: number;          // 당일 거래량
  amount?: number;         // 당일 거래대금
  timestamp: string;       // 업데이트 시간
}

interface MovingAverages {
  sma5: number[];          // 5일 이동평균
  sma20: number[];         // 20일 이동평균  
  sma60: number[];         // 60일 이동평균
}
```

### KIS API 연동 방식

#### 차트 데이터 로딩 전략

**초기 로딩 (과거 데이터)**
- 차트 진입 시: 최근 1년(365일) 과거 데이터 조회
- KIS API를 통한 배치 조회
- 로컬 캐시에 저장 후 차트 렌더링

**실시간 업데이트 (현재 데이터)**
- 장중: WebSocket을 통한 실시간 가격 수신
- 새로운 캔들 데이터 실시간 추가/업데이트
- 현재가 정보 실시간 반영

#### 국내 주식 데이터 조회

**일봉 차트 과거 데이터**
```
GET /domestic/chart/daily/{symbol}
Parameters:
- symbol: 종목코드 (6자리)
- period: "D" (일봉 고정)
- count: 365 (1년치 과거 데이터)
- start_date: 1년전 날짜 (YYYYMMDD)
- end_date: 오늘 날짜 (YYYYMMDD)

Response: 365일치 OHLCV 데이터
```

**현재가 정보**
```
GET /domestic/price/{symbol}  
Parameters:
- symbol: 종목코드
- market: "J" (주식시장)

Response: 실시간 가격 정보 (초기 로딩 시에만)
```

**실시간 WebSocket 연동**
```
WebSocket Connection: ws://localhost:8002/ws/realtime
Subscribe Message:
{
  "action": "subscribe",
  "symbol": "005930",
  "market": "domestic",
  "dataType": ["price", "orderbook"]
}

Realtime Data:
{
  "symbol": "005930",
  "type": "price",
  "price": 69500,
  "change": +500,
  "changePercent": 0.72,
  "volume": 150000,
  "timestamp": "2024-01-15T10:30:15Z"
}
```

#### 해외 주식 데이터 조회

**일봉 차트 과거 데이터**
```
GET /overseas/{exchange}/chart/daily/{symbol}
Parameters:
- exchange: "NYS", "NAS" 등
- symbol: 티커 (예: AAPL)
- start_date: 1년전 날짜 (YYYYMMDD) - 필수
- end_date: 오늘 날짜 (YYYYMMDD) - 필수
- period: "D"

Response: 365일치 OHLCV 데이터 (USD 기준)
```

**현재가 정보**
```
GET /overseas/{exchange}/price/{symbol}
Parameters:
- exchange: 거래소 코드
- symbol: 티커

Response: USD 기준 가격 정보 (초기 로딩 시에만)
```

**실시간 WebSocket 연동**
```
WebSocket Connection: ws://localhost:8002/ws/realtime
Subscribe Message:
{
  "action": "subscribe",
  "symbol": "AAPL",
  "exchange": "NYS",
  "market": "overseas",
  "dataType": ["price"]
}

Realtime Data:
{
  "symbol": "AAPL",
  "exchange": "NYS", 
  "type": "price",
  "price": 185.25,
  "change": -2.15,
  "changePercent": -1.15,
  "volume": 50000000,
  "timestamp": "2024-01-15T14:30:15Z"
}
```

## 자동매매 신호 표시

### 매매 신호 계산 로직

#### 골든크로스/데드크로스
- **골든크로스**: 5일선이 20일선을 상향 돌파
- **데드크로스**: 5일선이 20일선을 하향 돌파
- **확인 조건**: 3일 연속 유지 시 신호 확정

#### 거래량 분석
- **거래량 급증**: 20일 평균 거래량 대비 200% 이상
- **거래량 감소**: 20일 평균 거래량 대비 50% 미만
- **동반 상승**: 가격 상승 + 거래량 급증

#### RSI 과매수/과매도
- **과매수**: RSI 70 이상
- **과매도**: RSI 30 이하  
- **기간**: 14일 기준

### 신호 표시 방식

#### 차트상 표시
- **매수 신호**: 초록 위쪽 화살표 (↑)
- **매도 신호**: 빨간 아래쪽 화살표 (↓)
- **관심 구간**: 노란 배경 하이라이트

#### 정보 패널
- 신호 발생 알림 메시지
- 신호 강도 (상/중/하)
- 예상 목표가/손절가

## 실시간 업데이트 정책

### 데이터 로딩 플로우

#### 차트 초기 진입
1. **과거 데이터 조회**: KIS API로 1년치(365일) 일봉 데이터 조회
2. **차트 렌더링**: 과거 데이터로 기본 차트 표시
3. **WebSocket 연결**: 실시간 데이터 수신 준비
4. **구독 시작**: 선택 종목에 대한 실시간 구독

#### 실시간 업데이트 (거래시간 중)
- **WebSocket 가격**: 실시간 가격 변동 즉시 반영
- **현재 캔들**: 당일 캔들 실시간 업데이트 (OHLCV)
- **이동평균**: 새 데이터 반영 시 자동 재계산
- **매매 신호**: 실시간 조건 검증 및 표시

#### 거래시간 외
- **WebSocket 연결**: 유지 (비활성 상태)
- **정적 데이터**: 장 마감 확정 데이터 표시
- **신호 계산**: 마지막 확정가 기준 계산

### WebSocket 연결 관리

#### 연결 생명주기
```typescript
// 차트 진입 시
1. KIS API → 과거 데이터 로딩 (365일)
2. 차트 초기 렌더링
3. WebSocket 연결
4. 종목 구독 시작

// 종목 변경 시
1. 기존 구독 해제
2. KIS API → 새 종목 과거 데이터 로딩
3. 차트 데이터 교체
4. 새 종목 구독 시작

// 차트 이탈 시
1. WebSocket 구독 해제
2. 연결 정리
3. 캐시 데이터 유지 (재진입 대비)
```

#### 데이터 동기화 전략

**하이브리드 동기화**
- **기반 데이터**: KIS API 과거 데이터 (신뢰성)
- **실시간 레이어**: WebSocket 현재가 (즉시성)
- **데이터 무결성**: WebSocket 데이터가 API 데이터와 연속성 유지

**캐시 정책**
- **장기 캐시**: 1년 과거 데이터 (LocalStorage, 24시간 유지)
- **세션 캐시**: 실시간 업데이트 데이터 (메모리, 세션 종료 시 삭제)
- **종목별 캐시**: 최대 10개 종목 과거 데이터 유지

#### 네트워크 최적화

**초기 로딩 최적화**
- **청크 로딩**: 1년 데이터를 분할 조회 (3개월씩 4회)
- **우선순위**: 최근 3개월 → 6개월 → 9개월 → 12개월 순서
- **점진적 렌더링**: 데이터 수신 즉시 차트 업데이트

**실시간 최적화**
- **배치 처리**: WebSocket 메시지 100ms 단위로 배치 처리
- **중복 제거**: 동일 종목 중복 메시지 필터링
- **Rate Limit**: 구독 종목 수 제한 (최대 10개)
- **자동 재연결**: 연결 끊김 시 5초 후 자동 재시도

## UI/UX 상세 설계

### 사용자 인터랙션

#### 차트 조작
- **확대/축소**: 핀치 제스처 또는 마우스 휠
- **좌우 스크롤**: 드래그로 시간 이동
- **십자선**: 터치/마우스로 정확한 값 표시
- **더블탭**: 자동 전체 보기

#### 종목 전환
- **검색**: 종목명 또는 코드 입력
- **즐겨찾기**: 관심종목 빠른 선택
- **최근 조회**: 최근 본 종목 리스트

### 반응형 디자인

#### 모바일 (< 768px)
- 세로형 레이아웃
- 터치 최적화 버튼 크기
- 스와이프 네비게이션

#### 태블릿 (768px ~ 1024px)  
- 가로/세로 모두 지원
- 추가 정보 패널 표시
- 멀티터치 제스처

#### 데스크톱 (> 1024px)
- 와이드 레이아웃
- 마우스 호버 효과
- 키보드 단축키 지원

## 성능 요구사항

### 응답시간 목표
- **초기 로딩**: 2초 이내
- **종목 전환**: 1초 이내  
- **차트 렌더링**: 500ms 이내
- **실시간 업데이트**: 지연 없음

### 메모리 관리
- **최대 메모리**: 100MB 이하
- **차트 데이터**: 종목당 100일치만 유지
- **가비지 컬렉션**: 5분마다 미사용 데이터 정리

## 에러 처리

### 네트워크 에러
- **연결 실패**: "네트워크 연결을 확인해주세요" 메시지
- **타임아웃**: 3초 후 재시도 버튼 표시
- **서버 에러**: "잠시 후 다시 시도해주세요" 안내

### 데이터 에러  
- **종목 없음**: "존재하지 않는 종목입니다" 알림
- **데이터 없음**: "차트 데이터가 없습니다" 메시지
- **토큰 만료**: 자동 갱신 후 재시도

### 사용자 에러
- **KIS 계정 미연결**: 계정 연결 안내 페이지로 이동
- **권한 없음**: "실시간 데이터 권한이 필요합니다" 안내

## 개발 단계별 계획

### Phase 1: 과거 데이터 기반 차트 (1주)
- KIS API 연동 (1년치 과거 데이터 조회)
- 캔들스틱 차트 기본 구현 (국내 일봉)
- 현재가 정보 표시 (초기 로딩용)
- 청크 로딩 및 점진적 렌더링

### Phase 2: 지표 및 실시간 연동 (1주)
- 이동평균선 3개 구현 (5일/20일/60일)
- 거래량 차트 추가
- WebSocket 실시간 연결 구현
- 실시간 가격 업데이트 및 캔들 갱신

### Phase 3: 고도화 및 최적화 (1주)
- 해외 주식 지원 (과거 데이터 + 실시간)
- 매매 신호 계산 및 표시 (골든크로스/데드크로스)
- 캐시 최적화 및 성능 개선
- 에러 처리 및 자동 재연결

## 추가 고려사항

### WebSocket 서버 구현 필요사항

KIS Adapter에 WebSocket 서버 기능 추가 필요:

**WebSocket 엔드포인트**
```
ws://localhost:8002/ws/realtime
```

**구독 관리**
- 종목별 구독자 관리
- KIS WebSocket API 연동
- 실시간 데이터 브로드캐스팅

**메시지 형식**
- 구독/해제 메시지 처리
- 실시간 가격/거래량 데이터 전송
- 에러 및 재연결 처리

### 데이터 형식 표준화

**통합 차트 데이터 형식**
```typescript
interface UnifiedChartData {
  symbol: string;
  market: 'domestic' | 'overseas';
  historical: CandleData[];     // 과거 1년 데이터
  realtime?: RealtimeData;      // 현재 실시간 데이터
  indicators: MovingAverages;   // 계산된 지표
}
```

이렇게 과거 데이터와 실시간 WebSocket을 결합한 하이브리드 차트 시스템으로 안정적이면서도 즉시성 있는 차트 서비스를 제공할 수 있습니다.